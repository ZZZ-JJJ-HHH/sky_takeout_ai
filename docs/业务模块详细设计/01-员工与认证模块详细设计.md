# 员工与认证模块详细设计文档

> **模块编号**：01  
> **模块名称**：员工与认证模块  
> **文档版本**：v1.0  
> **最后更新**：2024-01-20

---

## 一、业务背景与目标

### 1.1 业务背景

管理后台需要一套完整的员工账号体系，用于区分不同角色的后台操作人员（管理员、店长、普通员工），并确保只有授权员工才能访问后台管理功能。

### 1.2 业务目标

- 支持员工账号的创建、查询、修改、启用/禁用
- 实现员工登录/登出功能，基于 JWT 进行身份认证
- 区分不同角色（管理员、普通员工），为后续权限控制提供基础
- 记录关键操作的操作人信息，便于审计

---

## 二、详细业务流程

### 2.1 员工登录流程

```
1. 员工在登录页面输入用户名和密码
2. 前端提交登录请求到后端
3. 后端校验：
   - 用户名是否存在
   - 员工账号状态是否为启用（status = 1）
   - 密码是否正确（BCrypt 校验）
4. 登录成功：
   - 生成 JWT Token（包含员工 ID、用户名、角色）
   - 返回 Token 和员工基本信息（姓名、角色）
5. 前端保存 Token，后续请求携带在 Authorization 头中
6. 登录失败：返回错误提示（用户名不存在/密码错误/账号已禁用）
```

**异常分支**：
- 用户名不存在 → 返回错误码 3001，提示"用户名或密码错误"（不暴露具体是用户名问题）
- 密码错误 → 返回错误码 3001，提示"用户名或密码错误"
- 账号已禁用 → 返回错误码 3002，提示"账号已被禁用，请联系管理员"
- 账号状态异常（如已删除） → 返回错误码 3002

### 2.2 员工登出流程

```
1. 前端清除本地存储的 Token
2. 调用后端登出接口（可选，主要用于记录登出日志）
3. 后端记录登出日志（操作人、登出时间）
4. 前端跳转到登录页
```

**注意**：JWT 是无状态的，登出主要是前端清除 Token，后端可选择性记录日志。

### 2.3 员工管理流程（CRUD）

#### 2.3.1 新增员工

```
1. 管理员在员工管理页面点击"新增员工"
2. 填写员工信息：
   - 用户名（必填，唯一）
   - 姓名（必填）
   - 手机号（必填，用于联系）
   - 角色（管理员/普通员工）
   - 初始密码（必填，或系统生成）
3. 后端校验：
   - 用户名是否已存在
   - 手机号格式是否正确
   - 角色是否合法
4. 密码加密存储（BCrypt）
5. 创建员工记录，状态默认为"启用"
6. 记录创建人、创建时间
```

**业务规则**：
- 用户名全局唯一
- 初始密码建议强制要求首次登录修改（可选实现）
- 只有管理员角色可以创建员工

#### 2.3.2 查询员工列表

```
1. 支持分页查询
2. 支持按姓名、用户名模糊搜索
3. 支持按角色筛选
4. 支持按状态筛选（启用/禁用）
5. 返回员工列表（不返回密码字段）
```

#### 2.3.3 修改员工信息

```
1. 管理员选择要修改的员工
2. 可修改字段：
   - 姓名
   - 手机号
   - 角色
   - 状态（启用/禁用）
3. 不可修改字段：
   - 用户名（一旦创建不可修改）
   - 密码（通过单独接口修改）
4. 记录修改人、修改时间
```

**业务规则**：
- 禁用员工账号后，该员工无法登录
- 只有管理员可以修改员工信息

#### 2.3.4 删除员工（逻辑删除）

```
1. 管理员选择要删除的员工
2. 后端校验：
   - 员工是否存在
   - 员工是否有关联的订单或其他业务数据（可选校验）
3. 执行逻辑删除（is_deleted = 1）
4. 记录删除人、删除时间
```

**业务规则**：
- 已删除的员工无法登录
- 已删除的员工在列表中默认不显示（可通过筛选显示）

---

## 三、数据模型设计

### 3.1 员工表（employee）

| 字段名 | 类型 | 长度 | 是否必填 | 说明 | 示例值 |
|--------|------|------|----------|------|--------|
| id | BIGINT | - | 是（自增） | 主键 | 1 |
| username | VARCHAR | 32 | 是 | 用户名，唯一索引 | "admin" |
| name | VARCHAR | 32 | 是 | 员工姓名 | "张三" |
| password | VARCHAR | 64 | 是 | 密码（BCrypt 加密） | "$2a$10$..." |
| phone | VARCHAR | 11 | 是 | 手机号 | "13800138000" |
| sex | VARCHAR | 2 | 否 | 性别（0-女，1-男） | "1" |
| id_number | VARCHAR | 18 | 否 | 身份证号 | "110101199001011234" |
| status | INT | - | 是 | 状态（0-禁用，1-启用），默认1 | 1 |
| create_time | DATETIME | - | 是 | 创建时间 | 2024-01-20 10:00:00 |
| update_time | DATETIME | - | 是 | 更新时间 | 2024-01-20 10:00:00 |
| create_user | BIGINT | - | 是 | 创建人ID | 1 |
| update_user | BIGINT | - | 是 | 更新人ID | 1 |

**索引设计**：
- 主键索引：`id`
- 唯一索引：`username`
- 普通索引：`phone`（用于手机号查询）

**业务约束**：
- `username` 全局唯一
- `status` 默认值为 1（启用）
- `create_time`、`update_time` 自动维护
- `create_user`、`update_user` 由登录拦截器自动填充

### 3.2 角色枚举（业务层面）

当前简化实现，角色信息直接存储在 `employee` 表中，通过 `status` 字段区分：
- **管理员**：可管理员工、查看所有订单、查看报表
- **普通员工**：可管理菜品、处理订单，不可管理员工和查看报表

**未来扩展**：如需更细粒度权限，可引入 `role` 表和 `employee_role` 关联表。

---

## 四、接口详细设计

### 4.1 员工登录接口

**接口路径**：`POST /admin/auth/login`

**请求参数**（`EmployeeLoginDTO`）：

| 字段名 | 类型 | 是否必填 | 说明 | 示例值 |
|--------|------|----------|------|--------|
| username | String | 是 | 用户名 | "admin" |
| password | String | 是 | 密码（明文） | "123456" |

**响应数据**（`EmployeeLoginVO`）：

| 字段名 | 类型 | 说明 | 示例值 |
|--------|------|------|--------|
| token | String | JWT Token | "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..." |
| name | String | 员工姓名 | "张三" |
| role | String | 角色（可选，当前简化实现） | "admin" |

**业务规则**：
- 登录失败统一提示"用户名或密码错误"（不暴露具体原因）
- Token 有效期 24 小时
- Token 包含员工 ID、用户名、角色信息

**错误码**：
- `3001`：用户名或密码错误
- `3002`：账号已被禁用

### 4.2 员工登出接口

**接口路径**：`POST /admin/auth/logout`

**请求参数**：无（Token 通过请求头传递）

**响应数据**：`Result.success()`

**业务规则**：
- 主要作用是记录登出日志
- 前端清除 Token 后即可完成登出

### 4.3 新增员工接口

**接口路径**：`POST /admin/employee`

**请求参数**（`EmployeeCreateDTO`）：

| 字段名 | 类型 | 是否必填 | 说明 | 示例值 |
|--------|------|----------|------|--------|
| username | String | 是 | 用户名（唯一） | "zhangsan" |
| name | String | 是 | 姓名 | "张三" |
| phone | String | 是 | 手机号 | "13800138000" |
| sex | String | 否 | 性别（0-女，1-男） | "1" |
| idNumber | String | 否 | 身份证号 | "110101199001011234" |
| password | String | 是 | 初始密码（明文） | "123456" |

**响应数据**：`Result.success()`

**业务规则**：
- 用户名必须唯一，重复返回错误码 3003
- 密码自动加密存储
- 创建人、创建时间自动填充

**错误码**：
- `3003`：用户名已存在
- `1001`：参数校验失败（手机号格式、密码长度等）

### 4.4 查询员工列表接口

**接口路径**：`GET /admin/employee/page`

**请求参数**（查询参数）：

| 字段名 | 类型 | 是否必填 | 说明 | 示例值 |
|--------|------|----------|------|--------|
| page | Integer | 否 | 页码，默认1 | 1 |
| pageSize | Integer | 否 | 每页数量，默认10 | 10 |
| name | String | 否 | 姓名（模糊查询） | "张" |
| username | String | 否 | 用户名（模糊查询） | "admin" |

**响应数据**（分页结果）：

```json
{
  "code": 0,
  "msg": "success",
  "data": {
    "records": [
      {
        "id": 1,
        "username": "admin",
        "name": "管理员",
        "phone": "13800138000",
        "sex": "1",
        "status": 1,
        "createTime": "2024-01-20T10:00:00"
      }
    ],
    "total": 100,
    "size": 10,
    "current": 1,
    "pages": 10
  }
}
```

**业务规则**：
- 不返回密码字段
- 默认按创建时间倒序
- 支持姓名、用户名模糊搜索

### 4.5 修改员工接口

**接口路径**：`PUT /admin/employee`

**请求参数**（`EmployeeUpdateDTO`）：

| 字段名 | 类型 | 是否必填 | 说明 | 示例值 |
|--------|------|----------|------|--------|
| id | Long | 是 | 员工ID | 1 |
| name | String | 否 | 姓名 | "张三" |
| phone | String | 否 | 手机号 | "13800138000" |
| sex | String | 否 | 性别 | "1" |
| idNumber | String | 否 | 身份证号 | "110101199001011234" |
| status | Integer | 否 | 状态（0-禁用，1-启用） | 1 |

**响应数据**：`Result.success()`

**业务规则**：
- 用户名不可修改
- 密码通过单独接口修改
- 更新人、更新时间自动填充

### 4.6 根据ID查询员工接口

**接口路径**：`GET /admin/employee/{id}`

**请求参数**：路径参数 `id`（员工ID）

**响应数据**（`EmployeeVO`）：员工详细信息（不包含密码）

### 4.7 删除员工接口（逻辑删除）

**接口路径**：`DELETE /admin/employee/{id}`

**请求参数**：路径参数 `id`（员工ID）

**响应数据**：`Result.success()`

**业务规则**：
- 执行逻辑删除（`is_deleted = 1`）
- 删除后该员工无法登录
- 删除人、删除时间自动填充

---

## 五、前后端交互流程

### 5.1 登录流程时序图

```
前端                   后端（Controller）        后端（Service）        数据库
 |                          |                        |                    |
 |-- POST /admin/auth/login->|                       |                    |
 |                          |-- login(dto) --------> |                    |
 |                          |                        |-- selectByUsername->|
 |                          |                        |<-- Employee --------|
 |                          |                        |-- BCrypt.matches()  |
 |                          |                        |-- generateToken()   |
 |                          |<-- EmployeeLoginVO ----|                    |
 |<-- Result<EmployeeLoginVO>|                       |                    |
 |                          |                        |                    |
```

### 5.2 Token 校验流程

```
前端                   拦截器（JwtAuthInterceptor）   JwtUtil           数据库
 |                          |                          |                  |
 |-- GET /admin/xxx ------> |                          |                  |
 |   Authorization: Bearer  |                          |                  |
 |   <token>                |                          |                  |
 |                          |-- parseToken(token) ---> |                  |
 |                          |<-- Claims -------------- |                  |
 |                          |-- setLoginEmployeeContext()                 |
 |                          |-- 放行请求 ------------------------------->  |
 |                          |                          |                  |
```

---

## 六、测试用例与验收标准

### 6.1 登录功能测试用例

| 用例编号 | 测试场景 | 输入 | 预期结果 |
|----------|----------|------|----------|
| TC_LOGIN_001 | 正常登录 | 正确的用户名和密码 | 返回 Token 和员工信息，状态码 200 |
| TC_LOGIN_002 | 用户名不存在 | 不存在的用户名 | 返回错误码 3001，提示"用户名或密码错误" |
| TC_LOGIN_003 | 密码错误 | 正确的用户名，错误的密码 | 返回错误码 3001，提示"用户名或密码错误" |
| TC_LOGIN_004 | 账号已禁用 | 已禁用账号的用户名和密码 | 返回错误码 3002，提示"账号已被禁用" |
| TC_LOGIN_005 | 参数为空 | 用户名为空或密码为空 | 返回错误码 1001，提示参数校验失败 |

### 6.2 员工管理功能测试用例

| 用例编号 | 测试场景 | 输入 | 预期结果 |
|----------|----------|------|----------|
| TC_EMP_001 | 新增员工成功 | 合法的员工信息 | 创建成功，返回状态码 200 |
| TC_EMP_002 | 用户名重复 | 已存在的用户名 | 返回错误码 3003，提示"用户名已存在" |
| TC_EMP_003 | 查询员工列表 | 分页参数 | 返回员工列表，包含分页信息 |
| TC_EMP_004 | 修改员工信息 | 合法的修改数据 | 更新成功，返回状态码 200 |
| TC_EMP_005 | 删除员工 | 存在的员工ID | 逻辑删除成功，该员工无法登录 |

### 6.3 验收标准

- ✅ 所有接口通过 Swagger 文档验证
- ✅ 所有接口可通过 Postman 导入并测试
- ✅ 登录功能正常，Token 生成和校验正确
- ✅ 员工 CRUD 功能完整，数据正确性验证通过
- ✅ 权限控制正确，未登录无法访问管理接口
- ✅ 关键操作记录操作人信息
- ✅ 密码加密存储，不可明文查询

---

## 七、后续扩展规划

### 7.1 密码修改功能

- 员工可自行修改密码（需验证旧密码）
- 管理员可重置员工密码

### 7.2 角色权限细化

- 引入 `role` 表和 `permission` 表
- 实现基于角色的访问控制（RBAC）
- 支持菜单权限、按钮权限等细粒度控制

### 7.3 操作日志

- 记录员工的关键操作（登录、登出、数据修改等）
- 提供操作日志查询接口

---

## 八、相关文档

- **总体设计文档**：`苍穹外卖系统设计文档.md`
- **技术规范文档**：`约束规范文档.md`
- **数据库脚本**：`db/schema.sql`
