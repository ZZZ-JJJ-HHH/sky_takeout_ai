# 菜品管理模块详细设计文档

> **模块编号**：03  
> **模块名称**：菜品管理模块  
> **文档版本**：v1.0  
> **最后更新**：2024-01-20

---

## 一、业务背景与目标

### 1.1 业务背景

菜品是外卖系统的核心商品，需要支持菜品的完整生命周期管理：创建、修改、上下架、删除。菜品支持多种口味/规格选择（如辣度、大小、配菜等），用户下单时需要选择具体的口味/规格。

### 1.2 业务目标

- 支持菜品的增删改查、上下架、排序功能
- 支持菜品口味/规格的配置（一个菜品可以有多个口味维度，每个维度有多个选项）
- 支持菜品图片上传
- 确保菜品关联的分类存在且启用
- 停售菜品不影响已下单的订单
- 提供用户端菜品查询接口（只返回在售菜品）

---

## 二、详细业务流程

### 2.1 新增菜品流程

```
1. 管理员在菜品管理页面点击"新增菜品"
2. 填写菜品基本信息：
   - 菜品名称（必填）
   - 所属分类（必填，只能选择菜品分类）
   - 价格（必填，大于0）
   - 图片（可选，上传菜品图片）
   - 描述信息（可选）
   - 排序值（可选，默认0）
3. 配置菜品口味/规格（可选）：
   - 添加口味维度（如"辣度"、"大小"）
   - 为每个维度添加选项（如"微辣"、"中辣"、"重辣"）
4. 后端校验：
   - 菜品名称不能为空
   - 分类必须存在且为菜品分类（type=1）
   - 价格必须大于0
5. 创建菜品记录，状态默认为"停售"（需手动上架）
6. 如果配置了口味，创建口味记录
7. 记录创建人、创建时间
```

**业务规则**：
- 菜品创建后默认状态为"停售"，需手动上架后才能被用户看到
- 一个菜品可以有多个口味维度（如"辣度"、"大小"、"配菜"）
- 每个口味维度可以有多个选项值（JSON 格式存储）

### 2.2 修改菜品流程

```
1. 管理员选择要修改的菜品
2. 可修改字段：
   - 菜品名称
   - 所属分类
   - 价格
   - 图片
   - 描述信息
   - 排序值
   - 状态（在售/停售）
3. 可修改口味配置：
   - 修改现有口味维度
   - 新增口味维度
   - 删除口味维度
4. 后端校验：
   - 分类必须存在且为菜品分类
   - 价格必须大于0
5. 更新菜品记录
6. 同步更新口味记录（删除旧的口味，插入新的口味）
7. 记录更新人、更新时间
```

**业务规则**：
- 修改分类时，新分类必须是菜品分类
- 修改口味时，先删除该菜品所有旧口味，再插入新口味
- 停售菜品时，不影响已下单的订单

### 2.3 删除菜品流程

```
1. 管理员选择要删除的菜品
2. 后端校验：
   - 检查是否有关联的套餐（套餐中包含该菜品）
   - 检查是否有未完成的订单包含该菜品
   - 如有关联数据，不允许删除
3. 执行逻辑删除或物理删除
4. 同时删除该菜品的所有口味记录（级联删除）
5. 记录删除人、删除时间
```

**业务规则**：
- 被套餐包含的菜品不允许删除
- 有未完成订单的菜品不允许删除（可选，根据业务需求）
- 删除菜品时，级联删除所有口味记录

### 2.4 上下架菜品流程

```
1. 管理员选择要上架/下架的菜品
2. 上架校验：
   - 菜品所属分类必须启用
   - 菜品必须有价格
3. 更新菜品状态（status：0-停售，1-在售）
4. 记录更新人、更新时间
```

**业务规则**：
- 停售菜品时，用户端不再显示该菜品
- 已下单的订单不受影响

### 2.5 查询菜品列表流程（管理端）

```
1. 支持按分类筛选
2. 支持按状态筛选（在售/停售）
3. 支持按菜品名称模糊搜索
4. 支持分页查询
5. 返回菜品列表，包含基本信息（不包含口味详情）
6. 返回每个菜品关联的分类名称
```

**业务规则**：
- 默认按排序值升序，排序值相同按创建时间升序
- 列表查询不返回口味详情（减少数据量）

### 2.6 查询菜品详情流程（管理端）

```
1. 根据菜品ID查询
2. 返回菜品完整信息
3. 返回该菜品的所有口味配置
```

### 2.7 查询菜品列表流程（用户端）

```
1. 按分类查询（只返回在售菜品）
2. 支持按菜品名称模糊搜索
3. 返回菜品基本信息
4. 返回每个菜品的口味配置（用于用户选择）
```

**业务规则**：
- 只返回在售状态的菜品
- 只返回启用分类下的菜品
- 返回口味配置，供用户下单时选择

---

## 三、数据模型设计

### 3.1 菜品表（dish）

| 字段名 | 类型 | 长度 | 是否必填 | 说明 | 示例值 |
|--------|------|------|----------|------|--------|
| id | BIGINT | - | 是（自增） | 主键 | 1 |
| name | VARCHAR | 128 | 是 | 菜品名称 | "宫保鸡丁" |
| category_id | BIGINT | - | 是 | 分类ID（外键） | 1 |
| price | DECIMAL | 10,2 | 是 | 价格，大于0 | 28.00 |
| image | VARCHAR | 255 | 否 | 图片地址 | "/images/dish/xxx.jpg" |
| description | VARCHAR | 512 | 否 | 描述信息 | "经典川菜，麻辣鲜香" |
| status | TINYINT | - | 是 | 状态（0-停售，1-在售），默认0 | 1 |
| sort | INT | - | 是 | 排序值，默认0 | 0 |
| create_time | DATETIME | - | 是 | 创建时间 | 2024-01-20 10:00:00 |
| update_time | DATETIME | - | 是 | 更新时间 | 2024-01-20 10:00:00 |
| create_user | BIGINT | - | 否 | 创建人ID | 1 |
| update_user | BIGINT | - | 否 | 更新人ID | 1 |

**索引设计**：
- 主键索引：`id`
- 外键索引：`idx_dish_category_id (category_id)`
- 普通索引：`idx_dish_status (status)`（用于按状态查询）
- 普通索引：`idx_dish_name (name)`（用于名称搜索）

**业务约束**：
- `category_id` 外键关联 `category` 表
- `price` 必须大于 0
- `status` 默认值为 0（停售）
- `sort` 默认值为 0

### 3.2 菜品口味表（dish_flavor）

| 字段名 | 类型 | 长度 | 是否必填 | 说明 | 示例值 |
|--------|------|------|----------|------|--------|
| id | BIGINT | - | 是（自增） | 主键 | 1 |
| dish_id | BIGINT | - | 是 | 菜品ID（外键） | 1 |
| name | VARCHAR | 64 | 是 | 口味名称（维度名） | "辣度" |
| value | VARCHAR | 255 | 是 | 口味值列表（JSON格式） | '["微辣","中辣","重辣"]' |

**索引设计**：
- 主键索引：`id`
- 外键索引：`idx_flavor_dish_id (dish_id)`

**业务约束**：
- `dish_id` 外键关联 `dish` 表，级联删除
- `value` 字段存储 JSON 格式的选项列表，如：`["微辣","中辣","重辣"]`

**口味配置示例**：
```json
[
  {"name": "辣度", "value": ["微辣", "中辣", "重辣"]},
  {"name": "大小", "value": ["小份", "中份", "大份"]},
  {"name": "配菜", "value": ["不加配菜", "加香菜", "加葱花"]}
]
```

---

## 四、接口详细设计

### 4.1 新增菜品接口

**接口路径**：`POST /admin/dish`

**请求参数**（`DishCreateDTO`）：

| 字段名 | 类型 | 是否必填 | 说明 | 示例值 |
|--------|------|----------|------|--------|
| name | String | 是 | 菜品名称 | "宫保鸡丁" |
| categoryId | Long | 是 | 分类ID | 1 |
| price | BigDecimal | 是 | 价格，大于0 | 28.00 |
| image | String | 否 | 图片地址 | "/images/dish/xxx.jpg" |
| description | String | 否 | 描述信息 | "经典川菜" |
| sort | Integer | 否 | 排序值，默认0 | 0 |
| flavors | List<DishFlavorDTO> | 否 | 口味配置列表 | 见下方 |

**DishFlavorDTO**：

| 字段名 | 类型 | 是否必填 | 说明 | 示例值 |
|--------|------|----------|------|--------|
| name | String | 是 | 口味名称 | "辣度" |
| value | List<String> | 是 | 口味值列表 | ["微辣","中辣","重辣"] |

**响应数据**：`Result.success()`

**业务规则**：
- 分类必须是菜品分类（type=1）
- 价格必须大于0
- 创建后默认状态为停售

**错误码**：
- `3007`：分类不存在或不是菜品分类
- `3008`：价格必须大于0
- `1001`：参数校验失败

### 4.2 修改菜品接口

**接口路径**：`PUT /admin/dish`

**请求参数**（`DishUpdateDTO`）：

| 字段名 | 类型 | 是否必填 | 说明 | 示例值 |
|--------|------|----------|------|--------|
| id | Long | 是 | 菜品ID | 1 |
| name | String | 否 | 菜品名称 | "宫保鸡丁" |
| categoryId | Long | 否 | 分类ID | 1 |
| price | BigDecimal | 否 | 价格 | 28.00 |
| image | String | 否 | 图片地址 | "/images/dish/xxx.jpg" |
| description | String | 否 | 描述信息 | "经典川菜" |
| sort | Integer | 否 | 排序值 | 0 |
| status | Integer | 否 | 状态（0-停售，1-在售） | 1 |
| flavors | List<DishFlavorDTO> | 否 | 口味配置列表 | 见上方 |

**响应数据**：`Result.success()`

**业务规则**：
- 修改口味时，先删除旧口味，再插入新口味
- 上架时需校验分类是否启用

**错误码**：
- `3007`：分类不存在或不是菜品分类
- `3009`：分类已禁用，无法上架菜品

### 4.3 删除菜品接口

**接口路径**：`DELETE /admin/dish/{id}`

**请求参数**：路径参数 `id`（菜品ID）

**响应数据**：`Result.success()`

**业务规则**：
- 被套餐包含的菜品不允许删除
- 删除菜品时，级联删除所有口味记录

**错误码**：
- `3010`：该菜品被套餐包含，无法删除
- `3011`：该菜品存在未完成订单，无法删除

### 4.4 批量删除菜品接口

**接口路径**：`DELETE /admin/dish`

**请求参数**（请求体）：`List<Long> ids`（菜品ID列表）

**响应数据**：`Result.success()`

**业务规则**：同单个删除，批量校验

### 4.5 查询菜品列表接口（管理端）

**接口路径**：`GET /admin/dish/page`

**请求参数**（查询参数）：

| 字段名 | 类型 | 是否必填 | 说明 | 示例值 |
|--------|------|----------|------|--------|
| page | Integer | 否 | 页码，默认1 | 1 |
| pageSize | Integer | 否 | 每页数量，默认10 | 10 |
| name | String | 否 | 菜品名称（模糊查询） | "鸡丁" |
| categoryId | Long | 否 | 分类ID | 1 |
| status | Integer | 否 | 状态（0-停售，1-在售） | 1 |

**响应数据**（分页结果）：

```json
{
  "code": 0,
  "msg": "success",
  "data": {
    "records": [
      {
        "id": 1,
        "name": "宫保鸡丁",
        "categoryId": 1,
        "categoryName": "热菜",
        "price": 28.00,
        "image": "/images/dish/xxx.jpg",
        "description": "经典川菜",
        "status": 1,
        "sort": 0,
        "createTime": "2024-01-20T10:00:00"
      }
    ],
    "total": 100,
    "size": 10,
    "current": 1,
    "pages": 10
  }
}
```

**业务规则**：
- 默认按排序值升序，排序值相同按创建时间升序
- 返回分类名称（关联查询）

### 4.6 查询菜品详情接口（管理端）

**接口路径**：`GET /admin/dish/{id}`

**请求参数**：路径参数 `id`（菜品ID）

**响应数据**（`DishVO`）：

```json
{
  "code": 0,
  "msg": "success",
  "data": {
    "id": 1,
    "name": "宫保鸡丁",
    "categoryId": 1,
    "categoryName": "热菜",
    "price": 28.00,
    "image": "/images/dish/xxx.jpg",
    "description": "经典川菜",
    "status": 1,
    "sort": 0,
    "flavors": [
      {
        "name": "辣度",
        "value": ["微辣", "中辣", "重辣"]
      }
    ],
    "createTime": "2024-01-20T10:00:00"
  }
}
```

**业务规则**：返回菜品完整信息，包含口味配置

### 4.7 查询菜品列表接口（用户端）

**接口路径**：`GET /api/dish/list`

**请求参数**（查询参数）：

| 字段名 | 类型 | 是否必填 | 说明 | 示例值 |
|--------|------|----------|------|--------|
| categoryId | Long | 否 | 分类ID | 1 |
| name | String | 否 | 菜品名称（模糊查询） | "鸡丁" |

**响应数据**（`List<DishVO>`）：

```json
{
  "code": 0,
  "msg": "success",
  "data": [
    {
      "id": 1,
      "name": "宫保鸡丁",
      "categoryId": 1,
      "price": 28.00,
      "image": "/images/dish/xxx.jpg",
      "description": "经典川菜",
      "flavors": [
        {
          "name": "辣度",
          "value": ["微辣", "中辣", "重辣"]
        }
      ]
    }
  ]
}
```

**业务规则**：
- 只返回在售状态的菜品
- 只返回启用分类下的菜品
- 返回口味配置，供用户选择

---

## 五、前后端交互流程

### 5.1 新增菜品流程时序图

```
前端                   后端（Controller）        后端（Service）        数据库
 |                          |                        |                    |
 |-- POST /admin/dish ----->|                        |                    |
 |   {name, categoryId,     |                        |                    |
 |    price, flavors}       |                        |                    |
 |                          |-- saveDish(dto) ----->|                    |
 |                          |                        |-- validateCategory->|
 |                          |                        |<-- valid -----------|
 |                          |                        |-- insert(dish) ---->|
 |                          |                        |<-- dishId=1 --------|
 |                          |                        |-- insert(flavors) ->|
 |                          |                        |<-- success ---------|
 |                          |<-- success -------------|                    |
 |<-- Result.success() -----|                        |                    |
 |                          |                        |                    |
```

### 5.2 修改菜品口味流程

```
前端                   后端（Controller）        后端（Service）        数据库
 |                          |                        |                    |
 |-- PUT /admin/dish ------>|                        |                    |
 |   {id, flavors: [...]}   |                        |                    |
 |                          |-- updateDish(dto) ---->|                    |
 |                          |                        |-- deleteFlavors() ->|
 |                          |                        |<-- success ---------|
 |                          |                        |-- insertFlavors() ->|
 |                          |                        |<-- success ---------|
 |                          |<-- success -------------|                    |
 |<-- Result.success() -----|                        |                    |
 |                          |                        |                    |
```

---

## 六、测试用例与验收标准

### 6.1 新增菜品测试用例

| 用例编号 | 测试场景 | 输入 | 预期结果 |
|----------|----------|------|----------|
| TC_DISH_001 | 正常新增菜品 | 合法的菜品信息 | 创建成功，状态为停售，返回状态码 200 |
| TC_DISH_002 | 分类不存在 | 不存在的分类ID | 返回错误码 3007 |
| TC_DISH_003 | 分类不是菜品分类 | 套餐分类ID | 返回错误码 3007 |
| TC_DISH_004 | 价格小于等于0 | price=0 | 返回错误码 3008 |
| TC_DISH_005 | 菜品名称为空 | name为空 | 返回错误码 1001 |

### 6.2 修改菜品测试用例

| 用例编号 | 测试场景 | 输入 | 预期结果 |
|----------|----------|------|----------|
| TC_DISH_006 | 正常修改菜品 | 合法的修改数据 | 更新成功，返回状态码 200 |
| TC_DISH_007 | 修改口味配置 | 新的口味列表 | 旧口味删除，新口味插入成功 |
| TC_DISH_008 | 上架时分类已禁用 | status=1，分类已禁用 | 返回错误码 3009 |

### 6.3 删除菜品测试用例

| 用例编号 | 测试场景 | 输入 | 预期结果 |
|----------|----------|------|----------|
| TC_DISH_009 | 删除无关联菜品 | 无关联的菜品ID | 删除成功，口味记录级联删除 |
| TC_DISH_010 | 删除被套餐包含的菜品 | 被套餐包含的菜品ID | 返回错误码 3010 |

### 6.4 查询菜品测试用例

| 用例编号 | 测试场景 | 输入 | 预期结果 |
|----------|----------|------|----------|
| TC_DISH_011 | 管理端查询菜品列表 | 分页参数 | 返回所有状态的菜品 |
| TC_DISH_012 | 用户端查询菜品列表 | categoryId=1 | 只返回在售状态的菜品 |
| TC_DISH_013 | 查询菜品详情 | 菜品ID | 返回完整信息，包含口味配置 |

### 6.5 验收标准

- ✅ 所有接口通过 Swagger 文档验证
- ✅ 所有接口可通过 Postman 导入并测试
- ✅ 菜品 CRUD 功能完整，数据正确性验证通过
- ✅ 口味配置功能正常，增删改查正确
- ✅ 菜品上下架功能正常
- ✅ 删除菜品时的业务校验正确
- ✅ 用户端只返回在售菜品
- ✅ 图片上传功能正常（如已实现）

---

## 七、后续扩展规划

### 7.1 菜品图片管理

- 支持多图片上传
- 支持图片裁剪、压缩
- 支持图片存储到对象存储（OSS）

### 7.2 菜品库存管理

- 增加库存字段
- 支持库存预警
- 库存不足时自动下架

### 7.3 菜品销量统计

- 记录菜品销量
- 提供销量排行榜接口
- 支持按销量排序

### 7.4 菜品评价功能

- 用户可对菜品进行评价
- 显示菜品评分和评价数量

---

## 八、相关文档

- **总体设计文档**：`苍穹外卖系统设计文档.md`
- **技术规范文档**：`约束规范文档.md`
- **数据库脚本**：`db/schema.sql`
- **关联模块**：`02-分类管理模块详细设计.md`、`05-订单模块详细设计.md`