# 分类管理模块详细设计文档

> **模块编号**：02  
> **模块名称**：分类管理模块  
> **文档版本**：v1.0  
> **最后更新**：2024-01-20

---

## 一、业务背景与目标

### 1.1 业务背景

菜品和套餐需要按照分类进行组织管理，便于用户浏览和商家管理。分类体系分为两类：
- **菜品分类**：用于组织单个菜品（如"热菜"、"凉菜"、"主食"等）
- **套餐分类**：用于组织套餐（如"超值套餐"、"双人套餐"等）

### 1.2 业务目标

- 支持菜品分类和套餐分类的独立管理
- 支持分类的增删改查、启用/禁用、排序功能
- 确保分类名称在同一类型下唯一
- 禁用分类时，关联的菜品/套餐应提示无法操作
- 提供分类列表查询接口，供前端展示和选择

---

## 二、详细业务流程

### 2.1 新增分类流程

```
1. 管理员在分类管理页面选择分类类型（菜品分类/套餐分类）
2. 点击"新增分类"
3. 填写分类信息：
   - 分类名称（必填）
   - 分类类型（菜品分类/套餐分类）
   - 排序值（可选，默认0）
4. 后端校验：
   - 分类名称不能为空
   - 同一类型下分类名称不能重复
5. 创建分类记录，状态默认为"启用"
6. 记录创建人、创建时间
```

**业务规则**：
- 分类名称在同一类型下必须唯一
- 分类创建后默认启用状态
- 排序值越小越靠前

### 2.2 修改分类流程

```
1. 管理员选择要修改的分类
2. 可修改字段：
   - 分类名称
   - 排序值
   - 状态（启用/禁用）
3. 后端校验：
   - 修改后的分类名称在同一类型下不能重复（排除自身）
4. 更新分类记录
5. 记录更新人、更新时间
```

**业务规则**：
- 分类类型创建后不可修改
- 禁用分类时，需检查是否有关联的菜品/套餐在售，如有则提示无法禁用

### 2.3 删除分类流程

```
1. 管理员选择要删除的分类
2. 后端校验：
   - 检查是否有关联的菜品/套餐
   - 如有关联数据，不允许删除，提示"该分类下存在菜品/套餐，无法删除"
3. 执行逻辑删除（is_deleted = 1）或物理删除
4. 记录删除人、删除时间
```

**业务规则**：
- 有关联菜品/套餐的分类不允许删除
- 删除后，该分类不再出现在列表中

### 2.4 查询分类列表流程

```
1. 支持按分类类型筛选（菜品分类/套餐分类）
2. 支持按状态筛选（启用/禁用）
3. 支持按分类名称模糊搜索
4. 返回分类列表，按排序值升序排列
5. 返回每个分类下的菜品/套餐数量（可选）
```

**业务规则**：
- 默认按排序值升序，排序值相同按创建时间升序
- 管理端查询可包含禁用分类，用户端只返回启用分类

---

## 三、数据模型设计

### 3.1 分类表（category）

| 字段名 | 类型 | 长度 | 是否必填 | 说明 | 示例值 |
|--------|------|------|----------|------|--------|
| id | BIGINT | - | 是（自增） | 主键 | 1 |
| name | VARCHAR | 64 | 是 | 分类名称 | "热菜" |
| type | TINYINT | - | 是 | 分类类型（1-菜品分类，2-套餐分类） | 1 |
| sort | INT | - | 是 | 排序值，默认0 | 0 |
| status | TINYINT | - | 是 | 状态（0-禁用，1-启用），默认1 | 1 |
| create_time | DATETIME | - | 是 | 创建时间 | 2024-01-20 10:00:00 |
| update_time | DATETIME | - | 是 | 更新时间 | 2024-01-20 10:00:00 |
| create_user | BIGINT | - | 否 | 创建人ID | 1 |
| update_user | BIGINT | - | 否 | 更新人ID | 1 |

**索引设计**：
- 主键索引：`id`
- 唯一索引：`uk_category_name_type (name, type)`（确保同一类型下分类名称唯一）
- 普通索引：`idx_category_type (type)`（用于按类型查询）
- 普通索引：`idx_category_status (status)`（用于按状态查询）

**业务约束**：
- `name` 和 `type` 组合唯一
- `type` 只能是 1（菜品分类）或 2（套餐分类）
- `status` 默认值为 1（启用）
- `sort` 默认值为 0

### 3.2 分类类型枚举

| 值 | 说明 | 用途 |
|----|------|------|
| 1 | 菜品分类 | 用于组织单个菜品 |
| 2 | 套餐分类 | 用于组织套餐 |

---

## 四、接口详细设计

### 4.1 新增分类接口

**接口路径**：`POST /admin/category`

**请求参数**（`CategoryCreateDTO`）：

| 字段名 | 类型 | 是否必填 | 说明 | 示例值 |
|--------|------|----------|------|--------|
| name | String | 是 | 分类名称 | "热菜" |
| type | Integer | 是 | 分类类型（1-菜品分类，2-套餐分类） | 1 |
| sort | Integer | 否 | 排序值，默认0 | 0 |

**响应数据**：`Result.success()`

**业务规则**：
- 分类名称在同一类型下必须唯一
- 创建人、创建时间自动填充

**错误码**：
- `3004`：分类名称已存在
- `1001`：参数校验失败（分类名称为空、类型不合法等）

### 4.2 修改分类接口

**接口路径**：`PUT /admin/category`

**请求参数**（`CategoryUpdateDTO`）：

| 字段名 | 类型 | 是否必填 | 说明 | 示例值 |
|--------|------|----------|------|--------|
| id | Long | 是 | 分类ID | 1 |
| name | String | 否 | 分类名称 | "热菜" |
| sort | Integer | 否 | 排序值 | 0 |
| status | Integer | 否 | 状态（0-禁用，1-启用） | 1 |

**响应数据**：`Result.success()`

**业务规则**：
- 分类类型不可修改
- 修改后的分类名称在同一类型下不能重复（排除自身）
- 禁用分类时，需检查是否有关联的菜品/套餐在售

**错误码**：
- `3004`：分类名称已存在
- `3005`：该分类下存在在售的菜品/套餐，无法禁用

### 4.3 删除分类接口

**接口路径**：`DELETE /admin/category/{id}`

**请求参数**：路径参数 `id`（分类ID）

**响应数据**：`Result.success()`

**业务规则**：
- 有关联菜品/套餐的分类不允许删除
- 执行逻辑删除或物理删除

**错误码**：
- `3006`：该分类下存在菜品/套餐，无法删除

### 4.4 查询分类列表接口（管理端）

**接口路径**：`GET /admin/category/list`

**请求参数**（查询参数）：

| 字段名 | 类型 | 是否必填 | 说明 | 示例值 |
|--------|------|----------|------|--------|
| type | Integer | 否 | 分类类型（1-菜品分类，2-套餐分类） | 1 |
| status | Integer | 否 | 状态（0-禁用，1-启用） | 1 |
| name | String | 否 | 分类名称（模糊查询） | "热" |

**响应数据**（`List<CategoryVO>`）：

```json
{
  "code": 0,
  "msg": "success",
  "data": [
    {
      "id": 1,
      "name": "热菜",
      "type": 1,
      "sort": 0,
      "status": 1,
      "createTime": "2024-01-20T10:00:00"
    }
  ]
}
```

**业务规则**：
- 默认按排序值升序，排序值相同按创建时间升序
- 可返回每个分类下的菜品/套餐数量（可选）

### 4.5 查询分类列表接口（用户端）

**接口路径**：`GET /api/category/list`

**请求参数**（查询参数）：

| 字段名 | 类型 | 是否必填 | 说明 | 示例值 |
|--------|------|----------|------|--------|
| type | Integer | 是 | 分类类型（1-菜品分类，2-套餐分类） | 1 |

**响应数据**：同管理端，但只返回启用状态的分类

**业务规则**：
- 只返回启用状态的分类
- 按排序值升序排列

### 4.6 根据ID查询分类接口

**接口路径**：`GET /admin/category/{id}`

**请求参数**：路径参数 `id`（分类ID）

**响应数据**（`CategoryVO`）：分类详细信息

---

## 五、前后端交互流程

### 5.1 新增分类流程时序图

```
前端                   后端（Controller）        后端（Service）        数据库
 |                          |                        |                    |
 |-- POST /admin/category ->|                        |                    |
 |   {name, type, sort}     |                        |                    |
 |                          |-- saveCategory(dto) -->|                    |
 |                          |                        |-- checkNameExists->|
 |                          |                        |<-- false ----------|
 |                          |                        |-- insert(category)->|
 |                          |                        |<-- success ---------|
 |                          |<-- success -------------|                    |
 |<-- Result.success() -----|                        |                    |
 |                          |                        |                    |
```

### 5.2 禁用分类校验流程

```
前端                   后端（Controller）        后端（Service）        数据库
 |                          |                        |                    |
 |-- PUT /admin/category ->|                        |                    |
 |   {id, status: 0}       |                        |                    |
 |                          |-- updateCategory(dto)->|                    |
 |                          |                        |-- checkHasDishes->|
 |                          |                        |<-- true -----------|
 |                          |<-- BusinessException --|                    |
 |<-- Result.error(3005) ---|                        |                    |
 |                          |                        |                    |
```

---

## 六、测试用例与验收标准

### 6.1 新增分类测试用例

| 用例编号 | 测试场景 | 输入 | 预期结果 |
|----------|----------|------|----------|
| TC_CAT_001 | 正常新增分类 | 合法的分类信息 | 创建成功，返回状态码 200 |
| TC_CAT_002 | 分类名称重复 | 已存在的分类名称和类型 | 返回错误码 3004，提示"分类名称已存在" |
| TC_CAT_003 | 分类名称为空 | 分类名称为空 | 返回错误码 1001，提示参数校验失败 |
| TC_CAT_004 | 分类类型不合法 | type 为 3 或其他非法值 | 返回错误码 1001，提示参数校验失败 |

### 6.2 修改分类测试用例

| 用例编号 | 测试场景 | 输入 | 预期结果 |
|----------|----------|------|----------|
| TC_CAT_005 | 正常修改分类 | 合法的修改数据 | 更新成功，返回状态码 200 |
| TC_CAT_006 | 修改后名称重复 | 修改后的名称与其他分类重复 | 返回错误码 3004 |
| TC_CAT_007 | 禁用有关联菜品的分类 | 禁用存在在售菜品的分类 | 返回错误码 3005，提示"该分类下存在在售的菜品/套餐，无法禁用" |

### 6.3 删除分类测试用例

| 用例编号 | 测试场景 | 输入 | 预期结果 |
|----------|----------|------|----------|
| TC_CAT_008 | 删除无关联分类 | 无关联菜品/套餐的分类ID | 删除成功，返回状态码 200 |
| TC_CAT_009 | 删除有关联分类 | 存在关联菜品/套餐的分类ID | 返回错误码 3006，提示"该分类下存在菜品/套餐，无法删除" |

### 6.4 查询分类测试用例

| 用例编号 | 测试场景 | 输入 | 预期结果 |
|----------|----------|------|----------|
| TC_CAT_010 | 查询菜品分类列表 | type=1 | 返回所有菜品分类，按排序值升序 |
| TC_CAT_011 | 查询套餐分类列表 | type=2 | 返回所有套餐分类，按排序值升序 |
| TC_CAT_012 | 用户端查询分类 | type=1 | 只返回启用状态的分类 |

### 6.5 验收标准

- ✅ 所有接口通过 Swagger 文档验证
- ✅ 所有接口可通过 Postman 导入并测试
- ✅ 分类 CRUD 功能完整，数据正确性验证通过
- ✅ 分类名称唯一性约束正确
- ✅ 禁用/删除分类时的业务校验正确
- ✅ 分类列表排序正确
- ✅ 用户端只返回启用分类

---

## 七、后续扩展规划

### 7.1 分类图标支持

- 为分类添加图标字段
- 支持上传分类图标
- 前端展示分类图标

### 7.2 分类层级支持

- 支持二级分类（如"热菜"下再分"川菜"、"湘菜"）
- 需要调整表结构，增加 `parent_id` 字段

### 7.3 分类统计信息

- 返回每个分类下的菜品/套餐数量
- 返回每个分类的销量统计

---

## 八、相关文档

- **总体设计文档**：`苍穹外卖系统设计文档.md`
- **技术规范文档**：`约束规范文档.md`
- **数据库脚本**：`db/schema.sql`
- **关联模块**：`03-菜品管理模块详细设计.md`、`04-套餐管理模块详细设计.md`
