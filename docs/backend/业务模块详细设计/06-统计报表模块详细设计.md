# 统计报表模块详细设计文档

> **模块编号**：06  
> **模块名称**：统计报表模块  
> **文档版本**：v1.0  
> **最后更新**：2024-01-20

---

## 一、业务背景与目标

### 1.1 业务背景

管理后台需要提供数据统计和报表功能，帮助商家了解经营状况，包括：
- 营业额统计（按天/周/月）
- 订单量统计（总订单数、有效订单数、取消订单数）
- 用户量统计（新增用户数、总用户数）
- 热门菜品/套餐统计（销量 Top N）

### 1.2 业务目标

- 提供多维度数据统计接口
- 支持按时间范围查询统计数据
- 提供可视化数据展示所需的数据格式
- 支持热门菜品/套餐排行
- 统计数据支持缓存，提升查询性能

---

## 二、详细业务流程

### 2.1 营业额统计流程

```
1. 管理员在数据看板页面选择统计维度（按天/周/月）
2. 选择时间范围（开始日期、结束日期）
3. 前端提交统计请求
4. 后端查询：
   - 根据时间范围查询订单表
   - 筛选已完成的订单（status=5）
   - 按统计维度分组汇总金额
5. 返回统计数据（日期、营业额）
6. 前端展示折线图或柱状图
```

**业务规则**：
- 只统计已完成的订单
- 按订单的完成时间（或支付时间）进行统计
- 支持按天、周、月三种维度统计

### 2.2 订单量统计流程

```
1. 管理员选择统计维度（按天/周/月）
2. 选择时间范围
3. 后端查询：
   - 总订单数：时间范围内的所有订单
   - 有效订单数：已完成的订单数
   - 取消订单数：已取消的订单数
4. 返回统计数据
5. 前端展示统计图表
```

**业务规则**：
- 总订单数包含所有状态的订单
- 有效订单数 = 已完成的订单数
- 取消订单数 = 已取消的订单数

### 2.3 用户量统计流程

```
1. 管理员选择统计维度（按天/周/月）
2. 选择时间范围
3. 后端查询：
   - 新增用户数：时间范围内注册的用户数
   - 总用户数：截止到结束日期的总用户数
4. 返回统计数据
5. 前端展示统计图表
```

**业务规则**：
- 新增用户数按注册时间统计
- 总用户数按截止日期统计

### 2.4 热门菜品/套餐统计流程

```
1. 管理员选择统计类型（菜品/套餐）
2. 选择时间范围
3. 选择Top N（如Top 10）
4. 后端查询：
   - 根据时间范围查询订单明细表
   - 按菜品/套餐分组，汇总销量
   - 按销量降序排列，取前N条
5. 返回热门菜品/套餐列表（名称、销量、销售额）
6. 前端展示排行榜
```

**业务规则**：
- 只统计已完成的订单
- 销量 = 订单明细中的数量总和
- 销售额 = 销量 × 单价

---

## 三、数据模型设计

### 3.1 统计查询说明

本模块主要基于现有表进行统计查询，不涉及新建表：
- **订单表（orders）**：用于营业额、订单量统计
- **订单明细表（order_detail）**：用于热门菜品/套餐统计
- **用户表（user）**：用于用户量统计

### 3.2 统计维度枚举

| 维度值 | 说明 | SQL 分组方式 |
|--------|------|--------------|
| 1 | 按天统计 | DATE(order_time) |
| 2 | 按周统计 | YEARWEEK(order_time) |
| 3 | 按月统计 | DATE_FORMAT(order_time, '%Y-%m') |

---

## 四、接口详细设计

### 4.1 营业额统计接口

**接口路径**：`GET /admin/report/turnover`

**请求参数**（查询参数）：

| 字段名 | 类型 | 是否必填 | 说明 | 示例值 |
|--------|------|----------|------|--------|
| begin | String | 是 | 开始日期（yyyy-MM-dd） | "2024-01-01" |
| end | String | 是 | 结束日期（yyyy-MM-dd） | "2024-01-31" |
| dimension | Integer | 否 | 统计维度（1-按天，2-按周，3-按月），默认1 | 1 |

**响应数据**（`TurnoverReportVO`）：

```json
{
  "code": 0,
  "msg": "success",
  "data": {
    "dateList": ["2024-01-01", "2024-01-02", "2024-01-03"],
    "turnoverList": [1200.00, 1500.00, 1800.00],
    "totalTurnover": 4500.00
  }
}
```

**业务规则**：
- 只统计已完成的订单（status=5）
- 按订单的完成时间或支付时间统计
- 返回日期列表和对应的营业额列表，便于前端绘制图表

### 4.2 订单量统计接口

**接口路径**：`GET /admin/report/orders`

**请求参数**（查询参数）：

| 字段名 | 类型 | 是否必填 | 说明 | 示例值 |
|--------|------|----------|------|--------|
| begin | String | 是 | 开始日期（yyyy-MM-dd） | "2024-01-01" |
| end | String | 是 | 结束日期（yyyy-MM-dd） | "2024-01-31" |
| dimension | Integer | 否 | 统计维度（1-按天，2-按周，3-按月），默认1 | 1 |

**响应数据**（`OrdersReportVO`）：

```json
{
  "code": 0,
  "msg": "success",
  "data": {
    "dateList": ["2024-01-01", "2024-01-02", "2024-01-03"],
    "totalOrderList": [50, 60, 70],
    "validOrderList": [45, 55, 65],
    "cancelOrderList": [5, 5, 5],
    "totalOrders": 180,
    "validOrders": 165,
    "cancelOrders": 15
  }
}
```

**业务规则**：
- 总订单数：所有状态的订单
- 有效订单数：已完成的订单（status=5）
- 取消订单数：已取消的订单（status=6）

### 4.3 用户量统计接口

**接口路径**：`GET /admin/report/users`

**请求参数**（查询参数）：

| 字段名 | 类型 | 是否必填 | 说明 | 示例值 |
|--------|------|----------|------|--------|
| begin | String | 是 | 开始日期（yyyy-MM-dd） | "2024-01-01" |
| end | String | 是 | 结束日期（yyyy-MM-dd） | "2024-01-31" |
| dimension | Integer | 否 | 统计维度（1-按天，2-按周，3-按月），默认1 | 1 |

**响应数据**（`UsersReportVO`）：

```json
{
  "code": 0,
  "msg": "success",
  "data": {
    "dateList": ["2024-01-01", "2024-01-02", "2024-01-03"],
    "newUserList": [10, 15, 20],
    "totalUserList": [100, 115, 135],
    "totalNewUsers": 45,
    "totalUsers": 135
  }
}
```

**业务规则**：
- 新增用户数：按注册时间统计
- 总用户数：截止到结束日期的累计用户数

### 4.4 热门菜品统计接口

**接口路径**：`GET /admin/report/topDish`

**请求参数**（查询参数）：

| 字段名 | 类型 | 是否必填 | 说明 | 示例值 |
|--------|------|----------|------|--------|
| begin | String | 是 | 开始日期（yyyy-MM-dd） | "2024-01-01" |
| end | String | 是 | 结束日期（yyyy-MM-dd） | "2024-01-31" |
| top | Integer | 否 | Top N，默认10 | 10 |

**响应数据**（`List<TopDishVO>`）：

```json
{
  "code": 0,
  "msg": "success",
  "data": [
    {
      "dishId": 10,
      "name": "宫保鸡丁",
      "sales": 150,
      "amount": 5700.00
    }
  ]
}
```

**业务规则**：
- 只统计已完成的订单
- 按销量降序排列
- 返回菜品ID、名称、销量、销售额

### 4.5 热门套餐统计接口

**接口路径**：`GET /admin/report/topSetmeal`

**请求参数**（查询参数）：

| 字段名 | 类型 | 是否必填 | 说明 | 示例值 |
|--------|------|----------|------|--------|
| begin | String | 是 | 开始日期（yyyy-MM-dd） | "2024-01-01" |
| end | String | 是 | 结束日期（yyyy-MM-dd） | "2024-01-31" |
| top | Integer | 否 | Top N，默认10 | 10 |

**响应数据**（`List<TopSetmealVO>`）：

```json
{
  "code": 0,
  "msg": "success",
  "data": [
    {
      "setmealId": 5,
      "name": "超值双人套餐",
      "sales": 80,
      "amount": 7040.00
    }
  ]
}
```

**业务规则**：
- 只统计已完成的订单
- 按销量降序排列
- 返回套餐ID、名称、销量、销售额

---

## 五、前后端交互流程

### 5.1 营业额统计流程时序图

```
前端                   后端（Controller）        后端（Service）        数据库
 |                          |                        |                    |
 |-- GET /admin/report/     |                        |                    |
 |   turnover?begin=...    |                        |                    |
 |                          |-- getTurnoverReport() ->|                    |
 |                          |                        |-- queryOrders() --->|
 |                          |                        |<-- List<Order> -----|
 |                          |                        |-- groupByDate() --->|
 |                          |                        |<-- Map<Date,Amount>|
 |                          |<-- TurnoverReportVO ----|                    |
 |<-- Result<TurnoverReportVO>|                        |                    |
 |                          |                        |                    |
```

### 5.2 热门菜品统计流程

```
前端                   后端（Controller）        后端（Service）        数据库
 |                          |                        |                    |
 |-- GET /admin/report/     |                        |                    |
 |   topDish?begin=...     |                        |                    |
 |                          |-- getTopDishReport() -->|                    |
 |                          |                        |-- queryOrderDetails->|
 |                          |                        |<-- List<Detail> ----|
 |                          |                        |-- groupByDish() --->|
 |                          |                        |-- sortBySales() --->|
 |                          |                        |<-- List<TopDish> ---|
 |                          |<-- List<TopDishVO> -----|                    |
 |<-- Result<List<TopDishVO>>|                        |                    |
 |                          |                        |                    |
```

---

## 六、测试用例与验收标准

### 6.1 营业额统计测试用例

| 用例编号 | 测试场景 | 输入 | 预期结果 |
|----------|----------|------|----------|
| TC_REP_001 | 正常统计营业额 | 有效的时间范围 | 返回营业额统计数据 |
| TC_REP_002 | 按天统计 | dimension=1 | 返回按天分组的营业额 |
| TC_REP_003 | 按月统计 | dimension=3 | 返回按月分组的营业额 |
| TC_REP_004 | 时间范围无效 | begin > end | 返回错误码 1001，参数校验失败 |

### 6.2 订单量统计测试用例

| 用例编号 | 测试场景 | 输入 | 预期结果 |
|----------|----------|------|----------|
| TC_REP_005 | 正常统计订单量 | 有效的时间范围 | 返回订单量统计数据 |
| TC_REP_006 | 统计总订单数 | - | 返回总订单数 |
| TC_REP_007 | 统计有效订单数 | - | 返回已完成的订单数 |
| TC_REP_008 | 统计取消订单数 | - | 返回已取消的订单数 |

### 6.3 用户量统计测试用例

| 用例编号 | 测试场景 | 输入 | 预期结果 |
|----------|----------|------|----------|
| TC_REP_009 | 正常统计用户量 | 有效的时间范围 | 返回用户量统计数据 |
| TC_REP_010 | 统计新增用户数 | - | 返回时间范围内注册的用户数 |
| TC_REP_011 | 统计总用户数 | - | 返回截止日期的总用户数 |

### 6.4 热门菜品/套餐统计测试用例

| 用例编号 | 测试场景 | 输入 | 预期结果 |
|----------|----------|------|----------|
| TC_REP_012 | 正常统计热门菜品 | 有效的时间范围和top值 | 返回Top N菜品列表 |
| TC_REP_013 | 正常统计热门套餐 | 有效的时间范围和top值 | 返回Top N套餐列表 |
| TC_REP_014 | Top值过大 | top=1000 | 返回所有符合条件的菜品/套餐 |

### 6.5 验收标准

- ✅ 所有接口通过 Swagger 文档验证
- ✅ 所有接口可通过 Postman 导入并测试
- ✅ 营业额统计准确，只统计已完成的订单
- ✅ 订单量统计准确，分类统计正确
- ✅ 用户量统计准确，时间范围正确
- ✅ 热门菜品/套餐统计准确，排序正确
- ✅ 统计数据支持缓存，提升查询性能
- ✅ 时间范围校验正确
- ✅ 数据格式便于前端图表展示

---

## 七、后续扩展规划

### 7.1 数据导出功能

- 支持统计数据导出为 Excel
- 支持按条件筛选导出
- 支持自定义导出字段

### 7.2 数据对比分析

- 支持同比、环比分析
- 支持多时间段对比
- 支持趋势预测

### 7.3 实时数据大屏

- 实时营业额展示
- 实时订单量展示
- 实时热门菜品展示
- 支持 WebSocket 推送更新

### 7.4 自定义报表

- 支持自定义统计维度
- 支持自定义统计指标
- 支持报表模板保存

### 7.5 数据预警功能

- 营业额异常预警
- 订单量异常预警
- 库存不足预警

---

## 八、相关文档

- **总体设计文档**：`苍穹外卖系统设计文档.md`
- **技术规范文档**：`约束规范文档.md`
- **数据库脚本**：`db/schema.sql`
- **关联模块**：`05-订单模块详细设计.md`
