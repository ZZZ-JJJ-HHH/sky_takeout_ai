# 套餐管理模块详细设计文档

> **模块编号**：04  
> **模块名称**：套餐管理模块  
> **文档版本**：v1.0  
> **最后更新**：2024-01-20

---

## 一、业务背景与目标

### 1.1 业务背景

套餐是将多个菜品组合在一起，以优惠价格销售的商品形式。套餐管理需要支持：
- 套餐基本信息管理（名称、分类、价格、图片、描述）
- 套餐与菜品的关联关系管理（一个套餐包含多个菜品，每个菜品有数量）
- 套餐的上下架管理
- 用户端套餐列表查询

### 1.2 业务目标

- 支持套餐的完整 CRUD 操作
- 支持套餐与菜品的关联管理（添加/删除套餐中的菜品，设置菜品数量）
- 支持套餐的上下架功能
- 提供用户端套餐列表查询接口（只显示在售套餐）
- 套餐价格应合理（可等于或低于所含菜品价格总和）

---

## 二、详细业务流程

### 2.1 新增套餐流程

```
1. 管理员在套餐管理页面点击"新增套餐"
2. 填写套餐基本信息：
   - 套餐名称（必填）
   - 套餐分类（必填，必须是套餐分类）
   - 套餐价格（必填）
   - 套餐图片（可选）
   - 套餐描述（可选）
3. 添加套餐包含的菜品：
   - 选择菜品（从菜品列表中选择）
   - 设置每个菜品的数量（默认1）
   - 可添加多个菜品
4. 后端校验：
   - 套餐名称不能为空
   - 套餐分类必须是套餐分类（type=2）
   - 套餐价格必须大于0
   - 套餐至少包含一个菜品
5. 创建套餐记录
6. 创建套餐菜品关联记录（setmeal_dish 表）
7. 记录创建人、创建时间
```

**业务规则**：
- 套餐分类必须是套餐分类类型（type=2）
- 套餐至少包含一个菜品
- 套餐创建后默认在售状态
- 套餐价格建议不超过所含菜品价格总和（业务提示，不强制）

### 2.2 修改套餐流程

```
1. 管理员选择要修改的套餐
2. 可修改字段：
   - 套餐名称
   - 套餐分类
   - 套餐价格
   - 套餐图片
   - 套餐描述
   - 套餐状态（在售/停售）
3. 可修改套餐包含的菜品：
   - 添加菜品
   - 删除菜品
   - 修改菜品数量
4. 后端校验：
   - 修改后的套餐分类必须是套餐分类
   - 套餐价格必须大于0
   - 套餐至少包含一个菜品
5. 更新套餐记录
6. 删除旧的套餐菜品关联记录
7. 创建新的套餐菜品关联记录
8. 记录更新人、更新时间
```

**业务规则**：
- 套餐分类修改后，需验证新分类是套餐分类类型
- 套餐菜品关联关系需要重新建立（先删后增）

### 2.3 删除套餐流程

```
1. 管理员选择要删除的套餐
2. 后端校验：
   - 检查套餐是否有关联的订单
   - 如有关联订单，不允许删除，提示"该套餐存在关联订单，无法删除"
3. 删除套餐菜品关联记录
4. 执行逻辑删除或物理删除套餐记录
5. 记录删除人、删除时间
```

**业务规则**：
- 有关联订单的套餐不允许删除
- 删除套餐时，同时删除套餐菜品关联记录

### 2.4 查询套餐列表流程（管理端）

```
1. 支持按套餐分类筛选
2. 支持按状态筛选（在售/停售）
3. 支持按套餐名称模糊搜索
4. 支持分页查询
5. 返回套餐列表，包含基本信息
6. 可选：返回每个套餐包含的菜品信息
```

**业务规则**：
- 默认按创建时间倒序
- 可返回套餐包含的菜品列表（用于管理端展示）

### 2.5 查询套餐列表流程（用户端）

```
1. 支持按套餐分类筛选
2. 只返回在售状态的套餐
3. 返回套餐基本信息
4. 返回套餐包含的菜品信息（菜品名称、数量、图片）
5. 不返回停售套餐
```

**业务规则**：
- 用户端只显示在售套餐
- 需要返回套餐包含的菜品信息，便于用户了解套餐内容

### 2.6 查询套餐详情流程

```
1. 根据套餐ID查询套餐详细信息
2. 返回套餐基本信息
3. 返回套餐包含的菜品列表（菜品ID、名称、数量、价格、图片）
4. 返回套餐分类信息
```

**业务规则**：
- 管理端可查询停售套餐详情
- 用户端只能查询在售套餐详情

---

## 三、数据模型设计

### 3.1 套餐表（setmeal）

| 字段名 | 类型 | 长度 | 是否必填 | 说明 | 示例值 |
|--------|------|------|----------|------|--------|
| id | BIGINT | - | 是（自增） | 主键 | 1 |
| name | VARCHAR | 128 | 是 | 套餐名称 | "超值双人套餐" |
| category_id | BIGINT | - | 是 | 分类ID（必须是套餐分类） | 5 |
| price | DECIMAL | 10,2 | 是 | 套餐价格 | 88.00 |
| image | VARCHAR | 255 | 否 | 图片地址 | "/images/setmeal/xxx.jpg" |
| description | VARCHAR | 512 | 否 | 描述信息 | "包含2个热菜+1个凉菜+2份米饭" |
| status | TINYINT | - | 是 | 状态（0-停售，1-在售），默认1 | 1 |
| create_time | DATETIME | - | 是 | 创建时间 | 2024-01-20 10:00:00 |
| update_time | DATETIME | - | 是 | 更新时间 | 2024-01-20 10:00:00 |
| create_user | BIGINT | - | 否 | 创建人ID | 1 |
| update_user | BIGINT | - | 否 | 更新人ID | 1 |

**索引设计**：
- 主键索引：`id`
- 普通索引：`idx_setmeal_category_id (category_id)`（用于按分类查询）
- 普通索引：`idx_setmeal_status (status)`（用于按状态查询）

**业务约束**：
- `category_id` 必须是套餐分类（type=2）
- `price` 必须大于0
- `status` 默认值为 1（在售）

### 3.2 套餐菜品关联表（setmeal_dish）

| 字段名 | 类型 | 长度 | 是否必填 | 说明 | 示例值 |
|--------|------|------|----------|------|--------|
| id | BIGINT | - | 是（自增） | 主键 | 1 |
| setmeal_id | BIGINT | - | 是 | 套餐ID | 1 |
| dish_id | BIGINT | - | 是 | 菜品ID | 10 |
| name | VARCHAR | 64 | 是 | 菜品名称（冗余字段，便于查询） | "宫保鸡丁" |
| price | DECIMAL | 10,2 | 是 | 菜品价格（冗余字段，便于查询） | 38.00 |
| copies | INT | - | 是 | 菜品份数，默认1 | 1 |

**索引设计**：
- 主键索引：`id`
- 普通索引：`idx_setmeal_dish_setmeal_id (setmeal_id)`（用于查询套餐包含的菜品）
- 普通索引：`idx_setmeal_dish_dish_id (dish_id)`（用于查询菜品被哪些套餐包含）
- 唯一索引：`uk_setmeal_dish (setmeal_id, dish_id)`（防止重复添加同一菜品）

**业务约束**：
- `setmeal_id` 和 `dish_id` 组合唯一
- `copies` 必须大于0，默认1
- `name` 和 `price` 为冗余字段，便于查询时直接获取，避免关联查询

---

## 四、接口详细设计

### 4.1 新增套餐接口

**接口路径**：`POST /admin/setmeal`

**请求参数**（`SetmealCreateDTO`）：

| 字段名 | 类型 | 是否必填 | 说明 | 示例值 |
|--------|------|----------|------|--------|
| name | String | 是 | 套餐名称 | "超值双人套餐" |
| categoryId | Long | 是 | 分类ID（必须是套餐分类） | 5 |
| price | BigDecimal | 是 | 套餐价格 | 88.00 |
| image | String | 否 | 图片地址 | "/images/setmeal/xxx.jpg" |
| description | String | 否 | 描述信息 | "包含2个热菜+1个凉菜+2份米饭" |
| setmealDishes | List<SetmealDishDTO> | 是 | 套餐包含的菜品列表 | 见下方 |

**SetmealDishDTO**：

| 字段名 | 类型 | 是否必填 | 说明 | 示例值 |
|--------|------|----------|------|--------|
| dishId | Long | 是 | 菜品ID | 10 |
| copies | Integer | 是 | 菜品份数，默认1 | 1 |

**响应数据**：`Result.success()`

**业务规则**：
- 套餐分类必须是套餐分类类型（type=2）
- 套餐至少包含一个菜品
- 套餐价格必须大于0
- 创建套餐菜品关联记录时，需要查询菜品信息填充 name 和 price

**错误码**：
- `3007`：套餐分类不是套餐分类类型
- `3008`：套餐至少包含一个菜品
- `1001`：参数校验失败

### 4.2 修改套餐接口

**接口路径**：`PUT /admin/setmeal`

**请求参数**（`SetmealUpdateDTO`）：

| 字段名 | 类型 | 是否必填 | 说明 | 示例值 |
|--------|------|----------|------|--------|
| id | Long | 是 | 套餐ID | 1 |
| name | String | 否 | 套餐名称 | "超值双人套餐" |
| categoryId | Long | 否 | 分类ID | 5 |
| price | BigDecimal | 否 | 套餐价格 | 88.00 |
| image | String | 否 | 图片地址 | "/images/setmeal/xxx.jpg" |
| description | String | 否 | 描述信息 | "包含2个热菜+1个凉菜+2份米饭" |
| status | Integer | 否 | 状态（0-停售，1-在售） | 1 |
| setmealDishes | List<SetmealDishDTO> | 否 | 套餐包含的菜品列表 | 见上方 |

**响应数据**：`Result.success()`

**业务规则**：
- 修改套餐菜品关联时，先删除旧的关联记录，再创建新的关联记录
- 套餐分类修改后，需验证新分类是套餐分类类型

**错误码**：
- `3007`：套餐分类不是套餐分类类型
- `3008`：套餐至少包含一个菜品

### 4.3 删除套餐接口

**接口路径**：`DELETE /admin/setmeal/{id}`

**请求参数**：路径参数 `id`（套餐ID）

**响应数据**：`Result.success()`

**业务规则**：
- 有关联订单的套餐不允许删除
- 删除套餐时，同时删除套餐菜品关联记录

**错误码**：
- `3009`：该套餐存在关联订单，无法删除

### 4.4 查询套餐列表接口（管理端）

**接口路径**：`GET /admin/setmeal/page`

**请求参数**（查询参数）：

| 字段名 | 类型 | 是否必填 | 说明 | 示例值 |
|--------|------|----------|------|--------|
| page | Integer | 否 | 页码，默认1 | 1 |
| pageSize | Integer | 否 | 每页数量，默认10 | 10 |
| name | String | 否 | 套餐名称（模糊查询） | "双人" |
| categoryId | Long | 否 | 分类ID | 5 |
| status | Integer | 否 | 状态（0-停售，1-在售） | 1 |

**响应数据**（分页结果）：

```json
{
  "code": 0,
  "msg": "success",
  "data": {
    "records": [
      {
        "id": 1,
        "name": "超值双人套餐",
        "categoryId": 5,
        "categoryName": "超值套餐",
        "price": 88.00,
        "image": "/images/setmeal/xxx.jpg",
        "description": "包含2个热菜+1个凉菜+2份米饭",
        "status": 1,
        "createTime": "2024-01-20T10:00:00"
      }
    ],
    "total": 100,
    "size": 10,
    "current": 1,
    "pages": 10
  }
}
```

**业务规则**：
- 默认按创建时间倒序
- 可返回套餐分类名称

### 4.5 查询套餐列表接口（用户端）

**接口路径**：`GET /api/setmeal/list`

**请求参数**（查询参数）：

| 字段名 | 类型 | 是否必填 | 说明 | 示例值 |
|--------|------|----------|------|--------|
| categoryId | Long | 否 | 分类ID | 5 |

**响应数据**（`List<SetmealVO>`）：

```json
{
  "code": 0,
  "msg": "success",
  "data": [
    {
      "id": 1,
      "name": "超值双人套餐",
      "categoryId": 5,
      "categoryName": "超值套餐",
      "price": 88.00,
      "image": "/images/setmeal/xxx.jpg",
      "description": "包含2个热菜+1个凉菜+2份米饭",
      "setmealDishes": [
        {
          "dishId": 10,
          "name": "宫保鸡丁",
          "price": 38.00,
          "copies": 1
        }
      ]
    }
  ]
}
```

**业务规则**：
- 只返回在售状态的套餐
- 返回套餐包含的菜品信息

### 4.6 根据ID查询套餐接口

**接口路径**：`GET /admin/setmeal/{id}` 或 `GET /api/setmeal/{id}`

**请求参数**：路径参数 `id`（套餐ID）

**响应数据**（`SetmealDetailVO`）：套餐详细信息，包含套餐菜品列表

**业务规则**：
- 管理端可查询停售套餐详情
- 用户端只能查询在售套餐详情

---

## 五、前后端交互流程

### 5.1 新增套餐流程时序图

```
前端                   后端（Controller）        后端（Service）        数据库
 |                          |                        |                    |
 |-- POST /admin/setmeal ->|                        |                    |
 |   {name, categoryId,     |                        |                    |
 |    price, dishes}        |                        |                    |
 |                          |-- saveSetmeal(dto) --->|                    |
 |                          |                        |-- validateCategory->|
 |                          |                        |<-- valid -----------|
 |                          |                        |-- insert(setmeal) ->|
 |                          |                        |<-- setmealId -------|
 |                          |                        |-- insertDishes() -->|
 |                          |                        |<-- success ---------|
 |                          |<-- success -------------|                    |
 |<-- Result.success() -----|                        |                    |
 |                          |                        |                    |
```

### 5.2 查询套餐详情流程

```
前端                   后端（Controller）        后端（Service）        数据库
 |                          |                        |                    |
 |-- GET /api/setmeal/{id}->|                        |                    |
 |                          |-- getSetmealById(id) ->|                    |
 |                          |                        |-- selectById() --->|
 |                          |                        |<-- Setmeal --------|
 |                          |                        |-- selectDishes() ->|
 |                          |                        |<-- List<Dish> ------|
 |                          |<-- SetmealDetailVO ----|                    |
 |<-- Result<SetmealDetailVO>|                        |                    |
 |                          |                        |                    |
```

---

## 六、测试用例与验收标准

### 6.1 新增套餐测试用例

| 用例编号 | 测试场景 | 输入 | 预期结果 |
|----------|----------|------|----------|
| TC_SET_001 | 正常新增套餐 | 合法的套餐信息和菜品列表 | 创建成功，返回状态码 200 |
| TC_SET_002 | 套餐分类不是套餐分类 | categoryId 指向菜品分类 | 返回错误码 3007 |
| TC_SET_003 | 套餐不包含菜品 | setmealDishes 为空 | 返回错误码 3008 |
| TC_SET_004 | 套餐价格为0 | price = 0 | 返回错误码 1001，参数校验失败 |

### 6.2 修改套餐测试用例

| 用例编号 | 测试场景 | 输入 | 预期结果 |
|----------|----------|------|----------|
| TC_SET_005 | 正常修改套餐 | 合法的修改数据 | 更新成功，返回状态码 200 |
| TC_SET_006 | 修改套餐菜品关联 | 更新 setmealDishes | 旧的关联删除，新的关联创建 |

### 6.3 删除套餐测试用例

| 用例编号 | 测试场景 | 输入 | 预期结果 |
|----------|----------|------|----------|
| TC_SET_007 | 删除无关联订单的套餐 | 无关联订单的套餐ID | 删除成功，返回状态码 200 |
| TC_SET_008 | 删除有关联订单的套餐 | 存在关联订单的套餐ID | 返回错误码 3009 |

### 6.4 查询套餐测试用例

| 用例编号 | 测试场景 | 输入 | 预期结果 |
|----------|----------|------|----------|
| TC_SET_009 | 用户端查询套餐列表 | categoryId=5 | 只返回在售套餐，包含菜品信息 |
| TC_SET_010 | 管理端查询套餐列表 | status=1 | 返回在售套餐列表 |
| TC_SET_011 | 查询套餐详情 | id=1 | 返回套餐详细信息，包含菜品列表 |

### 6.5 验收标准

- ✅ 所有接口通过 Swagger 文档验证
- ✅ 所有接口可通过 Postman 导入并测试
- ✅ 套餐 CRUD 功能完整，数据正确性验证通过
- ✅ 套餐菜品关联关系管理正确
- ✅ 套餐分类类型校验正确
- ✅ 用户端只返回在售套餐
- ✅ 套餐详情包含菜品信息

---

## 七、后续扩展规划

### 7.1 套餐图片上传

- 支持套餐图片上传功能
- 图片存储到本地或对象存储

### 7.2 套餐推荐功能

- 支持设置套餐为推荐套餐
- 用户端优先展示推荐套餐

### 7.3 套餐销量统计

- 统计套餐销量
- 支持按销量排序

### 7.4 套餐限时优惠

- 支持套餐限时优惠价格
- 设置优惠开始和结束时间

---

## 八、相关文档

- **总体设计文档**：`苍穹外卖系统设计文档.md`
- **技术规范文档**：`约束规范文档.md`
- **数据库脚本**：`db/schema.sql`
- **关联模块**：`02-分类管理模块详细设计.md`、`05-订单模块详细设计.md`
