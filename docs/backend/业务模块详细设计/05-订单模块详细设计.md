# 订单模块详细设计文档

> **模块编号**：05  
> **模块名称**：订单模块  
> **文档版本**：v1.0  
> **最后更新**：2024-01-20

---

## 一、业务背景与目标

### 1.1 业务背景

订单是外卖系统的核心业务，涉及用户下单、支付、商家接单、制作、派送、完成等完整流程。订单模块需要支持：
- 用户端：创建订单、支付订单、查看订单、取消订单
- 管理端：订单列表查询、订单详情查看、订单状态流转（接单、制作中、派送中、完成、取消）

### 1.2 业务目标

- 支持用户从购物车创建订单
- 支持订单支付流程（模拟支付）
- 支持订单状态流转（待支付 → 待接单 → 制作中 → 派送中 → 已完成）
- 支持订单取消功能（根据状态限制）
- 支持订单查询（用户端和管理端）
- 记录订单完整信息，便于后续统计和追溯

---

## 二、详细业务流程

### 2.1 创建订单流程

```
1. 用户在购物车页面点击"去结算"
2. 选择收货地址（如无地址，需先添加地址）
3. 填写备注信息（可选）
4. 前端提交订单创建请求，包含：
   - 用户ID（从Token获取）
   - 地址ID
   - 购物车项列表（菜品ID/套餐ID、数量、口味、金额）
   - 备注信息
5. 后端校验：
   - 用户是否登录
   - 地址是否存在且属于当前用户
   - 购物车项是否有效（菜品/套餐是否存在、是否在售）
   - 订单金额计算是否正确
6. 生成订单号（唯一，格式：时间戳+随机数）
7. 创建订单主记录（orders 表）
8. 创建订单明细记录（order_detail 表）
9. 清空购物车（可选，或保留购物车）
10. 返回订单信息（订单号、订单金额等）
```

**业务规则**：
- 订单号全局唯一，格式建议：`ORDER` + 时间戳 + 6位随机数
- 订单创建时状态为"待支付"（status=1）
- 订单金额 = 所有订单明细金额之和
- 订单明细需要保存菜品/套餐的快照信息（名称、价格、图片、口味）
- 地址信息冗余到订单表（防止地址修改影响历史订单）

### 2.2 支付订单流程（模拟支付）

```
1. 用户在订单详情页点击"立即支付"
2. 前端提交支付请求，包含订单号
3. 后端校验：
   - 订单是否存在
   - 订单是否属于当前用户
   - 订单状态是否为"待支付"
4. 执行模拟支付：
   - 更新订单支付状态（pay_status=1）
   - 更新订单状态为"待接单"（status=2）
   - 记录支付时间（checkout_time）
   - 创建支付记录（payment_record 表）
5. 返回支付成功结果
```

**业务规则**：
- 只有"待支付"状态的订单可以支付
- 支付成功后，订单状态自动变为"待接单"
- 支付记录用于后续对账和统计

### 2.3 订单状态流转流程（管理端）

#### 2.3.1 接单流程

```
1. 管理员在订单管理页面查看"待接单"订单
2. 点击"接单"按钮
3. 后端校验：
   - 订单状态是否为"待接单"
   - 订单是否已支付
4. 更新订单状态为"制作中"（status=3）
5. 记录操作人、操作时间
```

#### 2.3.2 开始制作流程

```
1. 管理员点击"开始制作"
2. 后端校验：订单状态是否为"待接单"或"制作中"
3. 更新订单状态为"制作中"（status=3）
```

#### 2.3.3 派送流程

```
1. 管理员点击"派送"
2. 后端校验：订单状态是否为"制作中"
3. 更新订单状态为"派送中"（status=4）
```

#### 2.3.4 完成订单流程

```
1. 管理员点击"完成订单"
2. 后端校验：订单状态是否为"派送中"
3. 更新订单状态为"已完成"（status=5）
```

### 2.4 取消订单流程

#### 2.4.1 用户取消订单

```
1. 用户在订单详情页点击"取消订单"
2. 填写取消原因（可选）
3. 前端提交取消请求
4. 后端校验：
   - 订单是否属于当前用户
   - 订单状态是否允许取消（待支付、待接单可以取消）
   - 制作中、派送中、已完成、已取消不能取消
5. 更新订单状态为"已取消"（status=6）
6. 记录取消原因
7. 如果已支付，执行退款流程（模拟，更新支付状态为退款）
```

**业务规则**：
- 只有"待支付"和"待接单"状态的订单用户可以取消
- 已支付的订单取消后，需要标记为退款状态

#### 2.4.2 管理端取消订单

```
1. 管理员在订单管理页面点击"取消订单"
2. 填写取消原因
3. 后端校验：订单状态是否允许取消
4. 更新订单状态为"已取消"
5. 记录取消原因和操作人
```

### 2.5 查询订单列表流程

#### 2.5.1 用户端查询订单列表

```
1. 用户进入"我的订单"页面
2. 支持按订单状态筛选（待支付、待接单、制作中、派送中、已完成、已取消）
3. 支持分页查询
4. 返回订单列表，包含：
   - 订单号
   - 订单金额
   - 订单状态
   - 下单时间
   - 订单明细数量
5. 默认按下单时间倒序
```

#### 2.5.2 管理端查询订单列表

```
1. 管理员进入订单管理页面
2. 支持多条件筛选：
   - 订单状态
   - 支付状态
   - 下单时间范围
   - 订单号（精确查询）
   - 用户手机号（模糊查询）
3. 支持分页查询
4. 返回订单列表，包含：
   - 订单号
   - 用户信息（手机号）
   - 订单金额
   - 订单状态
   - 支付状态
   - 下单时间
   - 收货地址信息
```

### 2.6 查询订单详情流程

```
1. 用户或管理员点击订单，查看订单详情
2. 根据订单ID查询订单主信息
3. 查询订单明细列表
4. 查询收货地址信息（从订单表冗余字段获取）
5. 返回完整的订单信息
```

---

## 三、数据模型设计

### 3.1 订单主表（orders）

| 字段名 | 类型 | 长度 | 是否必填 | 说明 | 示例值 |
|--------|------|------|----------|------|--------|
| id | BIGINT | - | 是（自增） | 主键 | 1 |
| order_number | VARCHAR | 64 | 是 | 订单号（唯一） | "ORDER20240120123456789012" |
| user_id | BIGINT | - | 是 | 用户ID | 100 |
| address_book_id | BIGINT | - | 是 | 地址簿ID | 5 |
| amount | DECIMAL | 10,2 | 是 | 订单金额 | 128.00 |
| status | TINYINT | - | 是 | 订单状态（1-待支付，2-待接单，3-制作中，4-派送中，5-已完成，6-已取消） | 2 |
| pay_status | TINYINT | - | 是 | 支付状态（0-未支付，1-已支付，2-退款），默认0 | 1 |
| pay_method | TINYINT | - | 是 | 支付方式（1-模拟支付），默认1 | 1 |
| remark | VARCHAR | 255 | 否 | 备注 | "不要辣" |
| cancel_reason | VARCHAR | 255 | 否 | 取消原因 | "临时有事" |
| order_time | DATETIME | - | 是 | 下单时间 | 2024-01-20 10:00:00 |
| checkout_time | DATETIME | - | 否 | 支付/结账时间 | 2024-01-20 10:05:00 |
| phone | VARCHAR | 20 | 是 | 联系电话（冗余） | "13800138000" |
| consignee | VARCHAR | 64 | 是 | 收货人（冗余） | "张三" |
| address | VARCHAR | 255 | 是 | 收货地址（冗余） | "北京市朝阳区xxx街道xxx号" |

**索引设计**：
- 主键索引：`id`
- 唯一索引：`uk_orders_order_number (order_number)`
- 普通索引：`idx_orders_user_id (user_id)`（用于查询用户的订单）
- 普通索引：`idx_orders_status (status)`（用于按状态查询）

**业务约束**：
- `order_number` 全局唯一
- `status` 只能是 1-6 之间的值
- `pay_status` 只能是 0、1、2
- 地址信息冗余存储，防止地址修改影响历史订单

### 3.2 订单明细表（order_detail）

| 字段名 | 类型 | 长度 | 是否必填 | 说明 | 示例值 |
|--------|------|------|----------|------|--------|
| id | BIGINT | - | 是（自增） | 主键 | 1 |
| order_id | BIGINT | - | 是 | 订单ID | 1 |
| dish_id | BIGINT | - | 否 | 菜品ID（菜品或套餐二选一） | 10 |
| setmeal_id | BIGINT | - | 否 | 套餐ID（菜品或套餐二选一） | NULL |
| name | VARCHAR | 128 | 是 | 菜品/套餐名称（快照） | "宫保鸡丁" |
| image | VARCHAR | 255 | 否 | 图片（快照） | "/images/dish/xxx.jpg" |
| dish_flavor | VARCHAR | 255 | 否 | 口味（快照） | "微辣" |
| number | INT | - | 是 | 数量 | 2 |
| amount | DECIMAL | 10,2 | 是 | 金额（单价×数量） | 76.00 |

**索引设计**：
- 主键索引：`id`
- 普通索引：`idx_order_detail_order_id (order_id)`（用于查询订单的明细）

**业务约束**：
- `dish_id` 和 `setmeal_id` 至少有一个不为空
- `name`、`image`、`dish_flavor`、`amount` 为快照字段，保存下单时的信息

### 3.3 支付记录表（payment_record）

| 字段名 | 类型 | 长度 | 是否必填 | 说明 | 示例值 |
|--------|------|------|----------|------|--------|
| id | BIGINT | - | 是（自增） | 主键 | 1 |
| order_id | BIGINT | - | 是 | 订单ID | 1 |
| pay_amount | DECIMAL | 10,2 | 是 | 支付金额 | 128.00 |
| pay_status | TINYINT | - | 是 | 支付状态（0-未支付，1-成功，2-失败） | 1 |
| pay_method | TINYINT | - | 是 | 支付方式（1-模拟支付） | 1 |
| pay_time | DATETIME | - | 否 | 支付时间 | 2024-01-20 10:05:00 |
| create_time | DATETIME | - | 是 | 创建时间 | 2024-01-20 10:05:00 |

**索引设计**：
- 主键索引：`id`
- 普通索引：`idx_payment_order_id (order_id)`（用于查询订单的支付记录）

### 3.4 订单状态枚举

| 值 | 说明 | 可执行操作 |
|----|------|------------|
| 1 | 待支付 | 支付、取消 |
| 2 | 待接单 | 接单、取消 |
| 3 | 制作中 | 派送 |
| 4 | 派送中 | 完成 |
| 5 | 已完成 | 无 |
| 6 | 已取消 | 无 |

### 3.5 支付状态枚举

| 值 | 说明 |
|----|------|
| 0 | 未支付 |
| 1 | 已支付 |
| 2 | 退款 |

---

## 四、接口详细设计

### 4.1 创建订单接口

**接口路径**：`POST /api/order/submit`

**请求参数**（`OrderSubmitDTO`）：

| 字段名 | 类型 | 是否必填 | 说明 | 示例值 |
|--------|------|----------|------|--------|
| addressBookId | Long | 是 | 地址簿ID | 5 |
| payMethod | Integer | 是 | 支付方式（1-模拟支付） | 1 |
| remark | String | 否 | 备注 | "不要辣" |

**响应数据**（`OrderSubmitVO`）：

| 字段名 | 类型 | 说明 | 示例值 |
|--------|------|------|--------|
| orderNumber | String | 订单号 | "ORDER20240120123456789012" |
| orderAmount | BigDecimal | 订单金额 | 128.00 |
| orderTime | LocalDateTime | 下单时间 | "2024-01-20T10:00:00" |

**业务规则**：
- 订单号自动生成，全局唯一
- 订单金额从购物车计算
- 订单创建后状态为"待支付"

**错误码**：
- `3010`：购物车为空
- `3011`：地址不存在
- `3012`：菜品/套餐已停售

### 4.2 支付订单接口

**接口路径**：`POST /api/order/payment`

**请求参数**（`OrderPaymentDTO`）：

| 字段名 | 类型 | 是否必填 | 说明 | 示例值 |
|--------|------|----------|------|--------|
| orderNumber | String | 是 | 订单号 | "ORDER20240120123456789012" |

**响应数据**：`Result.success()`

**业务规则**：
- 只有"待支付"状态的订单可以支付
- 支付成功后，订单状态变为"待接单"

**错误码**：
- `3013`：订单不存在
- `3014`：订单状态不允许支付
- `3015`：订单不属于当前用户

### 4.3 查询订单列表接口（用户端）

**接口路径**：`GET /api/order/userPage`

**请求参数**（查询参数）：

| 字段名 | 类型 | 是否必填 | 说明 | 示例值 |
|--------|------|----------|------|--------|
| page | Integer | 否 | 页码，默认1 | 1 |
| pageSize | Integer | 否 | 每页数量，默认10 | 10 |
| status | Integer | 否 | 订单状态（1-6） | 2 |

**响应数据**（分页结果）：

```json
{
  "code": 0,
  "msg": "success",
  "data": {
    "records": [
      {
        "id": 1,
        "orderNumber": "ORDER20240120123456789012",
        "amount": 128.00,
        "status": 2,
        "statusDesc": "待接单",
        "orderTime": "2024-01-20T10:00:00",
        "detailCount": 3
      }
    ],
    "total": 100,
    "size": 10,
    "current": 1,
    "pages": 10
  }
}
```

### 4.4 查询订单列表接口（管理端）

**接口路径**：`GET /admin/order/page`

**请求参数**（查询参数）：

| 字段名 | 类型 | 是否必填 | 说明 | 示例值 |
|--------|------|----------|------|--------|
| page | Integer | 否 | 页码，默认1 | 1 |
| pageSize | Integer | 否 | 每页数量，默认10 | 10 |
| orderNumber | String | 否 | 订单号（精确查询） | "ORDER20240120123456789012" |
| status | Integer | 否 | 订单状态 | 2 |
| payStatus | Integer | 否 | 支付状态 | 1 |
| beginTime | String | 否 | 开始时间 | "2024-01-20 00:00:00" |
| endTime | String | 否 | 结束时间 | "2024-01-20 23:59:59" |
| phone | String | 否 | 用户手机号（模糊查询） | "138" |

**响应数据**：分页结果，包含订单详细信息

### 4.5 查询订单详情接口

**接口路径**：`GET /api/order/{id}` 或 `GET /admin/order/{id}`

**请求参数**：路径参数 `id`（订单ID）

**响应数据**（`OrderDetailVO`）：

```json
{
  "code": 0,
  "msg": "success",
  "data": {
    "id": 1,
    "orderNumber": "ORDER20240120123456789012",
    "amount": 128.00,
    "status": 2,
    "statusDesc": "待接单",
    "payStatus": 1,
    "payStatusDesc": "已支付",
    "orderTime": "2024-01-20T10:00:00",
    "checkoutTime": "2024-01-20T10:05:00",
    "remark": "不要辣",
    "consignee": "张三",
    "phone": "13800138000",
    "address": "北京市朝阳区xxx街道xxx号",
    "orderDetails": [
      {
        "id": 1,
        "name": "宫保鸡丁",
        "image": "/images/dish/xxx.jpg",
        "dishFlavor": "微辣",
        "number": 2,
        "amount": 76.00
      }
    ]
  }
}
```

### 4.6 取消订单接口

**接口路径**：`PUT /api/order/cancel`

**请求参数**（`OrderCancelDTO`）：

| 字段名 | 类型 | 是否必填 | 说明 | 示例值 |
|--------|------|----------|------|--------|
| id | Long | 是 | 订单ID | 1 |
| cancelReason | String | 否 | 取消原因 | "临时有事" |

**响应数据**：`Result.success()`

**业务规则**：
- 只有"待支付"和"待接单"状态的订单可以取消
- 已支付的订单取消后，标记为退款状态

**错误码**：
- `3016`：订单状态不允许取消

### 4.7 接单接口（管理端）

**接口路径**：`PUT /admin/order/confirm`

**请求参数**（`OrderConfirmDTO`）：

| 字段名 | 类型 | 是否必填 | 说明 | 示例值 |
|--------|------|----------|------|--------|
| id | Long | 是 | 订单ID | 1 |

**响应数据**：`Result.success()`

**业务规则**：
- 只有"待接单"状态的订单可以接单
- 接单后，订单状态变为"制作中"

### 4.8 派送接口（管理端）

**接口路径**：`PUT /admin/order/delivery/{id}`

**请求参数**：路径参数 `id`（订单ID）

**响应数据**：`Result.success()`

**业务规则**：
- 只有"制作中"状态的订单可以派送
- 派送后，订单状态变为"派送中"

### 4.9 完成订单接口（管理端）

**接口路径**：`PUT /admin/order/complete/{id}`

**请求参数**：路径参数 `id`（订单ID）

**响应数据**：`Result.success()`

**业务规则**：
- 只有"派送中"状态的订单可以完成
- 完成后，订单状态变为"已完成"

---

## 五、前后端交互流程

### 5.1 创建订单流程时序图

```
前端                   后端（Controller）        后端（Service）        数据库
 |                          |                        |                    |
 |-- POST /api/order/submit->|                        |                    |
 |   {addressBookId, ...}   |                        |                    |
 |                          |-- submitOrder(dto) --->|                    |
 |                          |                        |-- getCartItems() ->|
 |                          |                        |<-- List<Cart> -----|
 |                          |                        |-- validateItems() ->|
 |                          |                        |-- generateOrderNo()->|
 |                          |                        |-- insert(order) --->|
 |                          |                        |<-- orderId --------|
 |                          |                        |-- insertDetails() ->|
 |                          |                        |<-- success --------|
 |                          |<-- OrderSubmitVO ------|                    |
 |<-- Result<OrderSubmitVO>--|                        |                    |
 |                          |                        |                    |
```

### 5.2 支付订单流程时序图

```
前端                   后端（Controller）        后端（Service）        数据库
 |                          |                        |                    |
 |-- POST /api/order/payment->|                        |                    |
 |   {orderNumber}           |                        |                    |
 |                          |-- payment(orderNo) --->|                    |
 |                          |                        |-- selectByOrderNo->|
 |                          |                        |<-- Order ----------|
 |                          |                        |-- validateStatus() |
 |                          |                        |-- updatePayStatus()->|
 |                          |                        |-- updateStatus() -->|
 |                          |                        |-- insertPayment() ->|
 |                          |                        |<-- success --------|
 |                          |<-- success -------------|                    |
 |<-- Result.success() -----|                        |                    |
 |                          |                        |                    |
```

---

## 六、测试用例与验收标准

### 6.1 创建订单测试用例

| 用例编号 | 测试场景 | 输入 | 预期结果 |
|----------|----------|------|----------|
| TC_ORD_001 | 正常创建订单 | 有效的地址ID和购物车 | 创建成功，返回订单号 |
| TC_ORD_002 | 购物车为空 | 购物车为空 | 返回错误码 3010 |
| TC_ORD_003 | 地址不存在 | 不存在的地址ID | 返回错误码 3011 |
| TC_ORD_004 | 菜品已停售 | 购物车包含停售菜品 | 返回错误码 3012 |

### 6.2 支付订单测试用例

| 用例编号 | 测试场景 | 输入 | 预期结果 |
|----------|----------|------|----------|
| TC_ORD_005 | 正常支付 | 待支付订单号 | 支付成功，订单状态变为待接单 |
| TC_ORD_006 | 订单不存在 | 不存在的订单号 | 返回错误码 3013 |
| TC_ORD_007 | 订单已支付 | 已支付订单号 | 返回错误码 3014 |
| TC_ORD_008 | 订单不属于当前用户 | 其他用户的订单号 | 返回错误码 3015 |

### 6.3 订单状态流转测试用例

| 用例编号 | 测试场景 | 输入 | 预期结果 |
|----------|----------|------|----------|
| TC_ORD_009 | 正常接单 | 待接单订单ID | 订单状态变为制作中 |
| TC_ORD_010 | 正常派送 | 制作中订单ID | 订单状态变为派送中 |
| TC_ORD_011 | 正常完成 | 派送中订单ID | 订单状态变为已完成 |
| TC_ORD_012 | 状态不允许操作 | 已完成订单接单 | 返回错误，提示状态不允许 |

### 6.4 取消订单测试用例

| 用例编号 | 测试场景 | 输入 | 预期结果 |
|----------|----------|------|----------|
| TC_ORD_013 | 正常取消待支付订单 | 待支付订单ID | 取消成功，订单状态变为已取消 |
| TC_ORD_014 | 正常取消待接单订单 | 待接单订单ID | 取消成功，订单状态变为已取消 |
| TC_ORD_015 | 取消已支付订单 | 已支付订单ID | 返回错误码 3016，提示"已支付订单无法取消" |
| TC_ORD_016 | 取消已完成订单 | 已完成订单ID | 返回错误码 3016，提示"已完成订单无法取消" |
| TC_ORD_017 | 订单不属于当前用户 | 其他用户的订单ID | 返回错误码 3015 |

### 6.5 查询订单测试用例

| 用例编号 | 测试场景 | 输入 | 预期结果 |
|----------|----------|------|----------|
| TC_ORD_018 | 用户端查询订单列表 | 用户ID | 返回该用户的所有订单，按时间倒序 |
| TC_ORD_019 | 管理端查询订单列表 | 分页参数 | 返回所有订单列表，支持筛选 |
| TC_ORD_020 | 查询订单详情 | 订单ID | 返回订单详细信息，包含订单明细 |
| TC_ORD_021 | 查询不存在的订单 | 不存在的订单ID | 返回错误码 3013 |

### 6.6 验收标准

- ✅ 所有接口通过 Swagger 文档验证
- ✅ 所有接口可通过 Postman 导入并测试
- ✅ 订单创建功能完整，数据正确性验证通过
- ✅ 订单支付流程正确，支付状态更新正确
- ✅ 订单状态流转正确，状态校验严格
- ✅ 订单取消规则正确，已支付订单无法取消
- ✅ 订单查询功能完整，权限控制正确
- ✅ 订单金额计算正确
- ✅ 购物车清空逻辑正确

---

## 七、后续扩展规划

### 7.1 订单评价功能

- 用户可对已完成订单进行评价
- 支持对订单中的菜品/套餐分别评价
- 显示订单评分和评价内容

### 7.2 订单退款功能

- 支持已支付订单的退款申请
- 退款审核流程
- 退款记录管理

### 7.3 订单催单功能

- 用户可对派送中订单进行催单
- 记录催单次数和时间
- 通知商家处理

### 7.4 订单统计与分析

- 订单量统计（按天/周/月）
- 订单金额统计
- 订单状态分布统计
- 热门菜品/套餐统计

### 7.5 订单导出功能

- 支持订单数据导出（Excel）
- 支持按条件筛选导出
- 导出订单明细信息

### 7.6 订单消息通知

- 订单状态变更时通知用户
- 支持短信、推送等多种通知方式
- 订单超时自动取消提醒

---

## 八、相关文档

- **总体设计文档**：`苍穹外卖系统设计文档.md`
- **技术规范文档**：`约束规范文档.md`
- **数据库脚本**：`db/schema.sql`
- **关联模块**：`03-菜品管理模块详细设计.md`、`04-套餐管理模块详细设计.md`、`06-统计报表模块详细设计.md`