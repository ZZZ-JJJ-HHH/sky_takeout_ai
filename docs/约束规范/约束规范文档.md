# 苍穹外卖项目 - 开发约束与规范文档

> **文档目的**：本文档记录项目开发过程中的核心约定、规范和技术决策，确保即使上下文丢失，所有开发人员（包括 AI）都能遵循统一标准。

---

## 一、代码规范

### 1.1 日志规范

- **禁止使用**：`System.out.println()`、`System.err.println()` 等直接输出
- **统一使用**：SLF4J Logger（通过 `LoggerFactory.getLogger()` 获取）
- **日志级别使用**：
  - `log.debug()`：调试信息，开发环境可见
  - `log.info()`：关键业务流程、操作记录（如登录、订单创建）
  - `log.warn()`：警告信息，不影响主流程但需关注
  - `log.error()`：错误信息，必须记录异常栈
- **示例**：
```java
private static final Logger log = LoggerFactory.getLogger(YourClass.class);
log.info("用户登录成功，用户名: {}", username);
log.error("订单创建失败", e);
```

### 1.2 异常处理规范

- **业务异常**：统一使用 `BusinessException`，携带错误码和错误消息
- **全局异常处理**：所有异常统一由 `GlobalExceptionHandler` 捕获并转换为 `Result<T>` 返回
- **异常信息**：业务异常记录 `info` 级别日志，系统异常记录 `error` 级别日志（含异常栈）
- **错误码约定**：
  - `0`：成功
  - `1001`：参数校验错误
  - `2001`：未登录或登录已过期
  - `2002`：无访问权限
  - `3001`：业务规则冲突（如菜品在售无法删除）
  - `5000`：系统内部错误

### 1.3 统一返回结构

- **所有接口响应**：必须使用 `Result<T>` 包装
- **成功响应**：`Result.success(data)` 或 `Result.success()`
- **失败响应**：通过 `BusinessException` 抛出，由全局异常处理器统一转换
- **响应格式**：
```json
{
  "code": 0,
  "msg": "success",
  "data": { }
}
```

### 1.4 分层架构规范

- **Controller 层**：
  - 只负责接收请求、参数校验、调用 Service、返回响应
  - **禁止**在 Controller 中编写复杂业务逻辑
  - 使用 `@Valid` 或 `@Validated` 进行参数校验
- **Service 层**：
  - 所有业务逻辑集中在 Service 层
  - Service 接口定义在 `service` 包，实现类在 `service.impl` 包
- **Mapper 层**：
  - 继承 `BaseMapper<T>`（MyBatis-Plus）
  - 复杂查询可自定义 SQL（XML 或注解方式）

---

## 二、API 设计规范

### 2.1 Swagger/OpenAPI 规范

- **所有 Controller**：必须在类上使用 `@Tag(name = "分组名称", description = "分组描述")`
- **所有接口方法**：必须在方法上使用 `@Operation(summary = "接口摘要", description = "接口详细描述")`
- **请求参数**：使用 `@Parameter`、`@Schema` 等注解描述参数
- **响应模型**：使用 `@Schema` 描述返回对象结构
- **文档访问地址**：
  - Swagger UI：`http://localhost:8080/swagger-ui.html` 或 `/swagger-ui/index.html`
  - OpenAPI JSON：`http://localhost:8080/v3/api-docs`
- **Postman 集成**：通过导入 `/v3/api-docs` 自动生成 Postman 接口集合

### 2.2 接口路径规范

- **管理后台接口**：统一前缀 `/admin/**`
- **用户端接口**：统一前缀 `/api/**`
- **示例**：
  - 管理端登录：`POST /admin/auth/login`
  - 用户端登录：`POST /api/auth/login`
  - 分类管理：`GET /admin/category/list`

### 2.3 请求与响应规范

- **数据格式**：全部使用 JSON
- **Content-Type**：`application/json`
- **字符编码**：UTF-8
- **日期时间格式**：统一使用 ISO 8601 格式（如 `2024-01-20T10:30:00`）或时间戳

---

## 三、安全与鉴权规范

### 3.1 JWT 认证规范

- **Token 传递方式**：HTTP 请求头 `Authorization: Bearer <token>`
- **Token 生成**：登录成功后由后端生成，包含用户 ID、用户名、角色等信息
- **Token 校验**：通过 `JwtAuthInterceptor` 拦截器统一校验
- **配置位置**：`application.yml` 中的 `security.jwt.*` 配置项
- **默认过期时间**：24 小时（86400 秒）

### 3.2 密码安全规范

- **密码存储**：使用 BCrypt 加密存储，禁止明文存储
- **密码校验**：使用 `BCryptPasswordEncoder.matches(rawPassword, encodedPassword)` 进行校验
- **初始密码**：新创建员工账号时，默认密码应通过安全方式告知（或要求首次登录修改）

### 3.3 权限控制规范

- **管理端接口**：所有 `/admin/**` 接口（除登录接口外）都需要登录认证
- **用户端接口**：根据业务需要，部分接口需要登录（如订单相关），部分接口可匿名访问（如菜品列表）
- **权限拦截**：通过 `WebMvcConfig` 配置拦截器，明确放行路径（如 `/admin/auth/login`、Swagger 相关路径）

---

## 四、数据访问规范

### 4.1 MyBatis-Plus 使用规范

- **基础 CRUD**：优先使用 MyBatis-Plus 提供的 `BaseMapper<T>` 方法
- **条件查询**：使用 `LambdaQueryWrapper<T>` 或 `QueryWrapper<T>` 构建查询条件
- **字段映射**：数据库字段使用下划线命名（`snake_case`），Java 实体使用驼峰命名（`camelCase`），通过 `map-underscore-to-camel-case: true` 自动转换
- **逻辑删除**：使用 `@TableLogic` 注解标记逻辑删除字段

### 4.2 实体类规范

- **Entity 类**：对应数据库表，使用 `@TableName` 指定表名
- **DTO 类**：用于接收请求参数，放在 `domain.dto` 包
- **VO 类**：用于返回给前端的数据，放在 `domain.vo` 包
- **字段校验**：DTO 类使用 Bean Validation 注解（`@NotNull`、`@NotBlank`、`@Size` 等）

---

## 五、技术栈约定

### 5.1 后端技术栈（固定版本）

- **Java**：17
- **Spring Boot**：3.x
- **Spring Web MVC**：随 Spring Boot 版本
- **MyBatis-Plus**：最新稳定版
- **MySQL**：8.x
- **Redis**：6.x 或更高
- **JWT**：使用 `io.jsonwebtoken:jjwt` 库
- **日志**：SLF4J + Logback（Spring Boot 默认）
- **接口文档**：SpringDoc OpenAPI（`springdoc-openapi-starter-webmvc-ui`）

### 5.2 数据库规范

- **字符集**：`utf8mb4`
- **排序规则**：`utf8mb4_unicode_ci`
- **表命名**：使用下划线命名（`snake_case`），如 `employee`、`order_detail`
- **字段命名**：使用下划线命名（`snake_case`）
- **主键**：统一使用 `id`（BIGINT，自增）
- **公共字段**：所有表包含 `create_time`、`update_time`（DATETIME 类型）
- **逻辑删除**：使用 `is_deleted`（TINYINT，0-未删除，1-已删除）

### 5.3 前端技术栈（规划中）

- **管理后台**：Vue 3 + TypeScript + Vite + Element Plus
- **用户端 H5**：Vue 3 + Vite + Vant（或 uni-app）

---

## 六、开发流程约定

### 6.1 模块开发顺序

1. **数据库设计**：先设计表结构，生成 `schema.sql`
2. **实体与 Mapper**：创建 Entity、Mapper 接口
3. **Service 层**：定义 Service 接口，实现业务逻辑
4. **Controller 层**：创建 Controller，添加 Swagger 注解
5. **前端对接**：前端调用接口，完成页面功能

### 6.2 代码提交规范（建议）

- **提交信息格式**：`[模块] 功能描述`，如 `[员工管理] 实现员工登录接口`
- **提交粒度**：一个功能点一次提交，避免大范围修改

### 6.3 测试规范

- **接口测试**：使用 Postman（通过 Swagger 自动导入）或 Swagger UI 进行接口测试
- **单元测试**：Service 层关键业务逻辑编写单元测试（JUnit 5）
- **集成测试**：关键业务流程编写集成测试

---

## 七、项目结构约定

### 7.1 包结构规范

```
com.sky.takeout
├── config          # 全局配置（跨域、拦截器、Swagger、Redis 等）
├── controller      # 控制器
│   ├── admin       # 管理端接口
│   └── user        # 用户端接口（可选，也可放在 controller 下）
├── service         # 业务接口
│   └── impl        # 业务实现
├── mapper          # MyBatis Mapper 接口
├── domain          # 领域模型
│   ├── entity      # 实体类（对应数据库表）
│   ├── dto         # 数据传输对象（请求参数）
│   └── vo          # 视图对象（响应数据）
├── common          # 公共组件
│   ├── result      # 统一返回结构
│   ├── exception   # 异常定义与处理
│   ├── constants   # 常量定义
│   ├── enums       # 枚举类型
│   └── utils       # 工具类
└── security        # 安全相关（JWT、用户上下文、拦截器等）
```

### 7.2 配置文件规范

- **主配置**：`application.yml`
- **环境配置**：`application-dev.yml`、`application-prod.yml`（可选）
- **数据库脚本**：`db/schema.sql`（建表脚本）

---

## 八、命名规范

### 8.1 Java 类命名

- **Controller**：`XxxController`，如 `EmployeeAuthController`
- **Service 接口**：`XxxService`，如 `EmployeeService`
- **Service 实现**：`XxxServiceImpl`，如 `EmployeeServiceImpl`
- **Mapper**：`XxxMapper`，如 `EmployeeMapper`
- **Entity**：实体名，如 `Employee`、`Dish`
- **DTO**：`XxxDTO`，如 `EmployeeLoginDTO`
- **VO**：`XxxVO`，如 `EmployeeLoginVO`
- **Exception**：`XxxException`，如 `BusinessException`

### 8.2 方法命名

- **查询单个**：`getXxx`、`findXxx`、`selectXxx`
- **查询列表**：`listXxx`、`getXxxList`
- **新增**：`saveXxx`、`addXxx`、`createXxx`
- **更新**：`updateXxx`、`modifyXxx`
- **删除**：`deleteXxx`、`removeXxx`

---

## 九、重要约定（必须遵守）

1. **所有接口必须使用 Swagger 注解**，确保可以通过 `/v3/api-docs` 导入 Postman
2. **禁止使用 `System.out.println`**，统一使用 SLF4J Logger
3. **所有接口响应必须使用 `Result<T>` 包装**
4. **业务异常统一使用 `BusinessException`**，由全局异常处理器统一处理
5. **Controller 层禁止编写复杂业务逻辑**，业务逻辑必须在 Service 层
6. **密码必须加密存储**，使用 BCrypt
7. **管理端接口路径统一前缀 `/admin/**`**，用户端接口路径统一前缀 `/api/**`
8. **所有表必须包含 `create_time`、`update_time` 字段**

---

## 十、文档更新记录

- **2024-01-20**：创建初始版本，记录项目启动阶段的核心规范
- 后续如有新增规范或变更，请在此处记录更新日期和变更内容

---

**备注**：本文档是项目开发的“宪法”，所有开发人员（包括 AI）都应严格遵循。如有特殊情况需要偏离规范，必须先在文档中说明原因并更新本文档。
