## 苍穹外卖（AI 重构版）系统设计文档

### 1. 项目概述

- **项目名称**：苍穹外卖（AI 重构版）
- **项目目标**：
  - 利用 AI 技术，从零生成完整的外卖业务系统，包括：后端、前端（管理端 + 用户端）、数据库脚本及基础部署脚本。
  - 保留经典「苍穹外卖」的核心业务能力：点餐、下单、支付、订单流转、后台运营管理。
  - 引入现代工程实践：分层架构、DTO/VO、统一异常处理、统一响应结构、日志规范、缓存与性能优化预留、可观测性预留接口。

- **业务范围**：
  - C 端用户：浏览菜品、管理地址、购物车、下单、支付（模拟）、查看订单、评价（可选）。
  - B 端管理：员工管理、菜品与套餐管理、分类管理、订单管理、数据统计看板。

- **简化/不实现范围**：
  - 第三方真实支付（微信/支付宝）：使用「模拟支付」流程。
  - 实际短信网关、消息推送：以日志输出或本地 Mock 服务代替。
  - 配送骑手体系：简化为订单状态流转，不设计独立骑手系统。

---

### 1.1 文档定位与关联

- **本设计文档**：专注于业务视角和系统架构视角，描述「要实现什么业务」「系统如何分层与拆模块」：
  - 业务流程、角色与终端；
  - 模块划分与数据模型（表清单）；
  - 接口分组与非功能性需求。
- **`约束规范文档.md`**：专注于技术与编码规范，描述「代码应该怎么写」：
  - 日志、异常、统一返回体、命名规范；
  - Swagger/OpenAPI 使用规范与 Postman 集成方式；
  - JWT、安全、MyBatis-Plus 使用规范与项目包结构等。
- **约定**：后续所有与「编码风格、日志、异常、接口文档细节、命名规则」相关的内容，统一维护在 `约束规范文档.md` 中；本设计文档只保留必要的高层技术选型说明。

### 1.2 文档体系结构

本项目采用**分层文档体系**，确保总体设计与详细实现分离，便于维护和协作：

#### 1.2.1 文档层级

- **第一层：总体设计文档（本文档）**
  - **定位**：项目全局视角，描述「要做什么业务」「系统如何分层与拆模块」
  - **内容**：项目概述、角色终端、业务流程概览、模块划分、数据模型清单、接口分组、非功能性需求
  - **受众**：项目负责人、架构师、新加入的开发者、AI 助手
  - **作用**：快速了解项目全貌，把握整体架构与业务边界

- **第二层：业务模块详细设计文档**
  - **位置**：`docs/业务模块详细设计/` 目录下
  - **命名规范**：`XX-模块名称详细设计.md`（如 `01-员工与认证模块详细设计.md`）
  - **定位**：单个业务模块的详细实现设计
  - **内容**：
    - 业务背景与目标
    - 详细业务流程（含状态流转、异常分支）
    - 数据模型详细设计（字段、约束、索引）
    - 接口详细设计（请求/响应字段、业务规则、错误码）
    - 前后端交互流程（时序图）
    - 测试用例与验收标准
    - 后续扩展规划
  - **受众**：负责该模块的开发人员、测试人员、AI 助手
  - **作用**：指导具体模块的开发实现，确保业务逻辑完整、接口设计清晰

- **第三层：技术规范文档**
  - **文档**：`约束规范文档.md`
  - **定位**：编码规范与技术实现标准
  - **内容**：日志规范、异常处理、统一返回体、命名规范、Swagger 使用、JWT 实现、数据库规范等
  - **作用**：确保代码风格统一，技术实现一致

#### 1.2.2 文档编写与维护规则

- **总体设计文档**：
  - 在项目启动阶段完成，后续仅在有重大架构调整时更新
  - 模块划分、业务流程概览应保持稳定

- **模块详细设计文档**：
  - **必须性**：每个业务模块在开发前，必须先完成对应的详细设计文档
  - **编写时机**：在开始编码该模块之前，由 AI 或开发人员根据总体设计文档生成
  - **更新时机**：模块开发过程中如有业务逻辑变更，需同步更新文档
  - **编号规则**：按开发顺序编号（01、02、03...），便于追踪

- **技术规范文档**：
  - 在项目初期建立，后续根据实际开发情况补充和完善
  - 所有技术实现细节统一维护在此文档

#### 1.2.3 文档关联关系

```
总体设计文档（本文档）
    ├── 引用 → 约束规范文档.md（技术实现标准）
    └── 细化 → docs/业务模块详细设计/
                    ├── 01-员工与认证模块详细设计.md
                    ├── 02-分类管理模块详细设计.md
                    ├── 03-菜品管理模块详细设计.md
                    ├── 04-套餐管理模块详细设计.md
                    ├── 05-订单模块详细设计.md
                    └── ...
```

**约定**：
- 总体设计文档描述「做什么」，模块详细设计文档描述「怎么做」
- 所有模块详细设计文档都应引用总体设计文档和约束规范文档
- AI 在生成代码时，应同时参考总体设计文档、对应模块的详细设计文档和约束规范文档

### 2. 系统角色与终端

- **系统角色**：
  - **管理员（平台运营）**：负责全局配置、员工管理、菜品和套餐管理、订单管理及数据统计。
  - **商家员工（店员/店长）**：日常运营、菜品维护、处理订单。
  - **普通用户（消费者）**：浏览菜品、下单、支付、评价。

- **终端类型（从业务视角）**：
  - **管理后台端**（PC 浏览器使用为主）：为管理员和商家员工提供运营管理能力。
  - **用户端应用**（移动端为主，可为 H5/小程序/APP）：为普通用户提供点餐、支付、查订单等能力。

---

### 3. 核心业务流程

#### 3.1 用户端业务流程

1. **用户注册 / 登录**
   - 手机号 + 短信验证码登录（验证码逻辑可模拟）。
   - 或保留预留接口用于第三方授权（微信登录）扩展。
2. **地址选择与维护**
   - 用户新增 / 编辑 / 删除收货地址。
   - 可设置默认地址。
3. **浏览与点餐**
   - 按分类浏览菜品与套餐。
   - 菜品支持不同口味或规格（如辣度、份量）。
   - 加入购物车、修改数量、删除购物车项。
4. **下单与支付（模拟）**
   - 提交订单（选择收货地址、备注信息）。
   - 执行「模拟支付」流程，更新支付状态。
5. **订单管理**
   - 查看订单列表与订单详情。
   - 订单状态：待支付、待接单、制作中、派送中、已完成、已取消等。
   - 用户可取消未完成订单（依据状态限制）。
6. **评价与反馈（可选）**
   - 用户对订单进行评价，提交内容/评分。

#### 3.2 管理后台业务流程

1. **员工登录**
   - 员工账号密码登录，密码加密存储。
2. **员工与权限管理**
   - 员工账号新增、启用/禁用。
   - 可选：角色与权限管理（简化版本可仅通过员工角色字段控制）。
3. **分类管理**
   - 管理菜品分类和套餐分类。
   - 支持新增、修改、删除、排序、启用/禁用。
4. **菜品管理**
   - 菜品信息维护：名称、分类、价格、图片、描述、状态（售卖/停售）。
   - 支持口味/规格配置（如辣度、大小、配菜选项等）。
   - 图片上传：本地存储或对象存储（先设计为本地/静态资源目录）。
5. **套餐管理**
   - 将多个菜品组合为套餐。
   - 设置套餐价格、图片、状态（售卖/停售）。
6. **订单管理**
   - 查看全部订单列表和详情。
   - 订单状态流转：待接单 → 制作中 → 派送中 → 已完成 / 已取消。
   - 支持订单筛选（按状态、时间范围、用户等）。
7. **数据统计看板**
   - 营业额统计（按天/周/月）。
   - 订单量统计（总订单数、有效订单数、取消订单数）。
   - 用户量统计（新增用户数、总用户数）。
   - 热门菜品统计（销量 Top N）。

---

### 4. 系统架构总体设计（业务视角）

- **整体形态**：前后端分离的单体系统：
  - 后端提供统一的业务服务与数据访问能力；
  - 前端分为管理端与用户端两个应用。
- **业务域划分**（后续实现时按此拆分模块或服务）：
  - **用户域**：用户、员工、权限、地址等。
  - **商品域**：菜品、口味、套餐、分类等。
  - **交易域**：购物车、订单、支付（模拟）等。
  - **运营域**：统计报表、热门菜品、运营指标等。
- **技术选型与具体框架**：统一归口到《约束规范文档.md》，本设计文档不再展开实现细节。

---

### 5. 业务模块划分

- **用户与员工模块**：
  - 员工登录、登出、账号管理。
  - C 端用户登录注册、用户信息维护。
  - 简化的角色/权限控制。
- **分类模块**：
  - 菜品分类、套餐分类的增删改查及启用/禁用。
- **菜品 / 套餐模块**：
  - 菜品 CRUD、口味配置、上下架。
  - 套餐 CRUD、关联菜品、上下架。
- **购物车模块**：
  - 按用户维度维护购物车（可存数据库表，也可用 Redis）。
  - 提供增删改查接口。
- **订单模块**：
  - 创建订单、模拟支付、订单状态流转逻辑。
  - 订单查询、订单取消、再来一单等接口。
- **统计报表模块**：
  - 基于订单和用户数据进行统计，提供报表接口。

---

### 6. 数据库概念模型设计（表清单）

本节先给出核心表清单与简要说明，后续将在数据库设计文档/脚本中细化字段与索引。

#### 6.1 用户与权限相关

- **`user`（用户表）**
  - 存储 C 端用户基本信息，如手机号、昵称、头像、注册时间等。
- **`employee`（员工表）**
  - 存储后台员工账号信息，如用户名、密码（加密）、姓名、角色、状态等。
- **`role`（角色表，可选）**
  - 定义角色信息，如管理员、店员等；初期可选，后续可扩展。
- **`employee_role`（员工角色关联表，可选）**
  - 关联员工与角色，支持多角色；如不需要复杂权限，可暂不实现。

#### 6.2 商品相关

- **`category`（分类表）**
  - 存储菜品分类和套餐分类，包含分类名称、类型（菜品/套餐）、排序、状态等。
- **`dish`（菜品表）**
  - 存储单个菜品基础信息：名称、分类、价格、图片、描述、状态等。
- **`dish_flavor`（菜品口味表）**
  - 存储菜品的口味/规格选项，例如辣度、配菜、规格等。
- **`setmeal`（套餐表）**
  - 存储套餐基础信息：名称、分类、价格、图片、描述、状态等。
- **`setmeal_dish`（套餐菜品关联表）**
  - 关联套餐与其包含的菜品，记录套餐中每个菜品的数量等信息。

#### 6.3 订单相关

- **`address_book`（地址簿表）**
  - 存储用户收货地址：联系人、手机号、详细地址、是否默认等。
- **`shopping_cart`（购物车表）**
  - 按用户维度维护购物车条目，可存数据库或 Redis（先设计数据库结构）。
- **`orders`（订单表）**
  - 订单主表，记录订单编号、用户、金额、状态、支付方式、下单时间、完成时间等。
- **`order_detail`（订单明细表）**
  - 记录订单中每个菜品/套餐的具体信息及数量、单价等。
- **`payment_record`（支付记录表）**
  - 存储模拟支付记录，如支付状态、支付时间、支付渠道（模拟字段）等。

#### 6.4 运营与统计（可选）

- **`user_feedback`（用户反馈/评价表）**
  - 存储用户对订单的评价与反馈。
- **统计相关表（可选）**
  - 当前阶段以实时统计或定时任务计算、Redis 缓存为主，必要时可新增预聚合表。

---

### 7. 接口设计与统一约定（概要）

#### 7.1 请求与响应规范（业务层面）

- **基础路径约定**：
  - 管理后台接口前缀：`/admin/**`（员工、菜品、订单、报表等后台能力）。
  - 用户端接口前缀：`/api/**`（用户登录、地址、购物车、下单等 C 端能力）。
- **数据格式**：全部使用 JSON。
- **业务语义**：
  - 所有接口通过统一结构返回「是否成功、业务提示、数据」，以便前端统一处理。
  - 详细的错误码表、统一返回体结构、异常映射规则参见 `约束规范文档.md`。

#### 7.2 鉴权与安全（业务层面）

- **身份体系**：
  - 管理端：基于员工账号密码的登录体系，区分管理员与普通员工角色。
  - 用户端：基于手机号（+ 短信验证码）或三方授权的登录体系。
- **访问控制原则**：
  - 管理端接口仅对登录员工开放，可按角色限制某些敏感操作（如员工管理、报表导出）。
  - 用户端订单、地址等敏感资源必须绑定当前登录用户，禁止越权访问。
- **技术实现细节**（JWT、请求头、拦截器、用户上下文等）已在 `约束规范文档.md` 中统一规范，这里不再展开。

#### 7.3 接口文档与 Postman 集成（概要）

- 本项目统一使用 OpenAPI/Swagger 维护接口文档，所有接口均通过注解生成文档。
- 文档 UI、OpenAPI JSON 地址以及 Controller 注解要求的技术细节，详见 `约束规范文档.md`。
- 业务要求：所有对外接口必须出现在在线文档中，且能够被 Postman 通过 OpenAPI 文档完整导入。

#### 7.4 接口分组（示例）

- **用户端 `/api/**`**：
  - `/api/auth/*`：登录/登出、验证码、注册（如需要）。
  - `/api/user/*`：用户信息、地址管理。
  - `/api/cart/*`：购物车相关接口。
  - `/api/dish/*`：菜品查询接口。
  - `/api/setmeal/*`：套餐查询接口。
  - `/api/order/*`：下单、订单列表、订单详情、取消订单等。

- **管理端 `/admin/**`**：
  - `/admin/auth/*`：员工登录/登出。
  - `/admin/employee/*`：员工管理接口。
  - `/admin/category/*`：分类管理接口。
  - `/admin/dish/*`：菜品管理接口。
  - `/admin/setmeal/*`：套餐管理接口。
  - `/admin/order/*`：订单管理接口。
  - `/admin/report/*`：报表统计接口。

---

### 8. 非功能性需求（NFR）

本节从业务目标出发描述非功能性要求，具体技术实现细节在《约束规范文档.md》中约定。

#### 8.1 性能与并发

- 希望在单机部署下，能够平稳支撑日常高峰期的下单和浏览场景（约百级 QPS），不影响用户点餐体验。
- 常见操作（浏览首页菜品列表、查看订单列表）应在可接受的响应时间内完成（如 200ms 级别，网络因素除外）。

#### 8.2 安全性

- 登录与鉴权必须保证账号安全，不得出现明文密码存储等问题。
- 用户隐私数据（手机号、地址等）需要受到保护，仅授权人员和本人可见。
- 对关键业务操作（如下单、取消订单、修改菜品价格）需要有可追溯性，方便审计。

#### 8.3 可维护性与可扩展性

- 业务模块之间边界清晰，后续可按业务域独立扩展或拆分部署。
- 新增业务功能时，应尽量复用既有模块（例如统一的用户体系、订单体系），避免重复造轮子。
- 需要预留一定空间用于后续对接真实支付、真实短信网关等外部系统。

---

### 9. 项目实施计划（业务视角）

为便于把握整体推进节奏，从业务角度规划以下实施步骤（技术实现细节可灵活调整）：

1. **需求与设计阶段**
   - 明确角色、核心业务流程与模块边界。
   - 评审并冻结本设计文档及数据库概念模型。
2. **基础能力阶段**
   - 打通员工登录、基础权限控制、菜单与路由框架、健康检查等基础能力。
3. **商品与订单主链路阶段**
   - 依次实现分类管理、菜品管理、套餐管理、购物车与下单流程，形成完整的「浏览 → 下单 → 支付（模拟）→ 查看订单」业务闭环。
4. **运营与报表阶段**
   - 在主链路稳定后，补充数据统计看板、热门菜品等运营功能。
5. **体验优化与扩展阶段**
   - 结合实际使用情况，优化性能与交互体验，预留对接第三方支付、短信网关等能力。

---

### 10. 后续工作

当前文档为「苍穹外卖（AI 重构版）」的总体设计文档，后续将基于本设计文档继续细化以下内容：

#### 10.1 模块详细设计文档

按照「1.2 文档体系结构」的约定，每个业务模块在开发前必须先完成对应的详细设计文档：

- ✅ **01-员工与认证模块详细设计.md**（已完成，作为模板）
- ⏳ **02-分类管理模块详细设计.md**（待创建）
- ⏳ **03-菜品管理模块详细设计.md**（待创建）
- ⏳ **04-套餐管理模块详细设计.md**（待创建）
- ⏳ **05-订单模块详细设计.md**（待创建）
- ⏳ **06-统计报表模块详细设计.md**（待创建）

**创建规则**：在开始编码某个模块之前，必须先由 AI 或开发人员根据总体设计文档生成对应的模块详细设计文档。

#### 10.2 其他后续工作

- 数据库详细设计文档与建表脚本（`db/schema.sql` 已创建，后续根据模块开发逐步完善）
- 前端页面原型与路由规划文档（待前端项目启动后创建）
- 部署与运维简要方案（开发环境、测试环境与简单生产环境）

#### 10.3 开发推进建议

接下来，可以以本设计文档为基础，按照以下顺序推进：

1. **完成模块详细设计文档**：为即将开发的模块创建详细设计文档
2. **生成数据库脚本**：根据模块详细设计完善 `db/schema.sql`
3. **实现后端接口**：根据模块详细设计文档和约束规范文档实现后端代码
4. **实现前端页面**：根据模块详细设计文档实现前端页面
5. **测试与验收**：根据模块详细设计文档中的测试用例进行验收

